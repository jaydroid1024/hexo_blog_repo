<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="EventBus 事件总线框架深入分析, 筑基、体系、实践、分享">
    <meta name="description" content="筑基、体系、实践、分享">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-N498NKZS3G"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-N498NKZS3G');
</script>


    <title>EventBus 事件总线框架深入分析 | 王学杰</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="王学杰" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">王学杰</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">王学杰</div>
        <div class="logo-desc">
            
            筑基、体系、实践、分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/jaydroid1024" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/jaydroid1024" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">EventBus 事件总线框架深入分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/">
                                <span class="chip bg-color">观察者模式</span>
                            </a>
                        
                            <a href="/tags/EventBus/">
                                <span class="chip bg-color">EventBus</span>
                            </a>
                        
                            <a href="/tags/%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/">
                                <span class="chip bg-color">事件总线</span>
                            </a>
                        
                            <a href="/tags/%E6%A1%86%E6%9E%B6/">
                                <span class="chip bg-color">框架</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E6%A1%86%E6%9E%B6/" class="post-category">
                                框架
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-01-31
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-11-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    14.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    57 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://raw.githubusercontent.com/jaydroid1024/jay_image_repo/main/img/post_banner_jay.png" alt=""></p>
<h1 id="EventBus-事件总线框架深入分析"><a href="#EventBus-事件总线框架深入分析" class="headerlink" title="EventBus 事件总线框架深入分析"></a>EventBus 事件总线框架深入分析</h1><h2 id="1-EventBus-关键词云"><a href="#1-EventBus-关键词云" class="headerlink" title="1. EventBus 关键词云"></a>1. EventBus 关键词云</h2><p>设计模式、数据结构、内存占用、查找效率、线程安全、对象池、事件继承问题、事件发布器、线程模式、同步、异步</p>
<h2 id="2-EventBus-快问快答"><a href="#2-EventBus-快问快答" class="headerlink" title="2. EventBus 快问快答"></a>2. EventBus 快问快答</h2><p>EventBus 中运用了那些设计模式</p>
<ul>
<li>观察者、单例、构建者、门面、策略</li>
</ul>
<p>EventBus 中运用了那些数据结构</p>
<ul>
<li>ThreadLocal、CopyOnWriteArrayList、ConcurrentHashMap、HashMap、PendingPostQueue</li>
</ul>
<p>EventBus 中的对象池</p>
<ul>
<li>FindState/FIND_STATE_POOL、PendingPost/pendingPostPool</li>
</ul>
<p>EventBus 中的锁与线程安全问题</p>
<ul>
<li>并发容器、同步锁、ThreadLocal</li>
</ul>
<p>如何设计一个最小原型 EventBus 框架需要考虑哪些问题</p>
<ul>
<li>内存占用、查找效率、线程安全</li>
</ul>
<p>EventBus 中的事件发布时如何实现同步、异步的</p>
<ul>
<li>同步：主线程、Handler；异步：子线程</li>
</ul>
<h2 id="3-EventBus-总结"><a href="#3-EventBus-总结" class="headerlink" title="3. EventBus 总结"></a>3. EventBus 总结</h2><h4 id="3-1-编译时APT流程总结"><a href="#3-1-编译时APT流程总结" class="headerlink" title="3.1 编译时APT流程总结"></a>3.1 编译时APT流程总结</h4><p>EventBus 中订阅者的收集是通过两种方式，一种是运行时反射收集，另一种是通过注解处理器收集。通过apt收集相比通过运行时反射的方式可以减少因为反射带来的性能开销，但是会影响编译时的时间。综合考量必然还是推荐通过APT方式。</p>
<p>通过APT方式收集订阅者的大体流程如下：</p>
<ul>
<li>在编码阶段添加订阅者方法时我们需要通过 <strong>@Subscribe</strong> 注解类标注订阅者，该注解类提供三个参数用来个性化配置订阅者，三个参数分别是：<strong>enum ThreadMode、boolean sticky，int priority</strong> 。注解处理器所做的工作就是收集订阅者方法以及这些方法所在的类信息。</li>
<li>EventBus 规定生成的索引类的全类名是由开发者自行定义传入的，所以在编译之前还模块的 build.gradle 中需要配置索引类，否则会编译错误。</li>
<li>注解处理器注解处理流程主要分为：<strong>收集订阅者、校验订阅者、生成索引类</strong>三个过程。<ul>
<li><strong>收集订阅者</strong>：遍历所有可执行元素 ExecutableElement，校验订阅者方法签名，订阅者方法签名需要满足 <strong>正好只有一个参数的非静态的公开的方法</strong> 的规则。然后将找到的订阅者方法和订阅者类存入 *<em>ListMap&lt;TypeElement, ExecutableElement&gt; methodsByClass *</em>  容器中。该容器的数据结构是：<code>HashMap&lt;K, List&lt;V&gt;&gt;()</code> key 存入的是订阅者类，value 是该类中所有订阅者方法的集合。</li>
<li><strong>校验订阅者</strong>（包括订阅者类/订阅者类的父类和订阅者方法）：<ul>
<li>校验订阅者类：遍历所有上一步收集到的订阅者类，校验订阅者类，订阅者类需要满足<strong>public/default+索引类和订阅者类的包名一样</strong> 的规则，不满足的订阅者类需要添加到 <strong>Set<typeelement> classesToSkip</typeelement></strong> 容器中标记。</li>
<li>校验订阅者类中的方法：满足上一步的订阅者类中任何一个订阅者方法满足以下情况的直接将对应的订阅者类需要添加到 <strong>Set<typeelement> classesToSkip</typeelement></strong> 容器中标记。<ul>
<li>订阅者方法的参数类型(也就是Event 类型)不是 DeclaredType 或者是 DeclaredType 但不是 TypeElement。</li>
<li>订阅者方法的参数类型是类类型但是对索引类不可见。</li>
</ul>
</li>
</ul>
</li>
<li><strong>生成索引类</strong>：遍历最终收集到的 <strong>methodsByClass</strong> 订阅者信息通过字符串拼接的方式生成索引类。这里换成Javapoet的方式更容易维护，EventBus 可能是为了节省框架包的体积没有采用Javapoet的方式生成java文件。</li>
</ul>
</li>
</ul>
<h4 id="3-2-初始化EventBus-总结"><a href="#3-2-初始化EventBus-总结" class="headerlink" title="3.2 初始化EventBus 总结"></a>3.2 初始化EventBus 总结</h4><p>总的来说 EventBus 的初始化流程不是很复杂， EventBus 对象的创建结合了单例模式和构建者模式。</p>
<p>单例模式常用于构建全局唯一类并提供全局唯一访问点。</p>
<p>构建者模式常用于构建可以通过设置不同的可选参数，定制化地创建一个复杂对象。</p>
<p>EventBus 恰好需要全局唯一且配置复杂，此时就可以结合两个设计模式应对不同的构建场景。</p>
<p>需要全局唯一默认配置的实例直接通过单例获取，需要为前面的单例个性化定制也可以通过构建者模式配置参数。</p>
<p>你自己维护全局唯一或者需要局部唯一的场景也可以通过构建者模式个性化定制。</p>
<p>可能是因为 EventBus  的应用场景多样，他的DCL单例模式并没有显示私有构造方法和静态实例变量，也就是说直接 new EventBus 也是可以的。</p>
<h4 id="3-3-注册订阅者流程总结"><a href="#3-3-注册订阅者流程总结" class="headerlink" title="3.3 注册订阅者流程总结"></a>3.3 注册订阅者流程总结</h4><p>注册订阅者分为查找和订阅两个过程</p>
<p>查找过程具体是通过当前订阅者类找出该类中声明的所有订阅者方法。查找逻辑封装在 SubscriberMethodFinder 类中，查找方式有两中，如果使用了注解处理器模块就可以通过生成的索引类查找，这种方式不需要通过反射就能收集到所有订阅者方法，效率较高。</p>
<p>还有一种就是运行时通过反射订阅者类的getMethods 或者getDeclaredMethods这两个方法收集订阅者方法，这种方式效率低，不推荐使用。</p>
<p>订阅过程具体是针对当前订阅者的每一个订阅者方法（查找流程得到）以事件类为范围进行全局排序，收集当前订阅者类的所有事件以及对粘性事件的分发。</p>
<h4 id="3-4-事件发布流程总结"><a href="#3-4-事件发布流程总结" class="headerlink" title="3.4 事件发布流程总结"></a>3.4 事件发布流程总结</h4><p>发布事件通过ThreadLocal保证发送时的同步问题，粘性事件就是发布前存到一个map中，当订阅者注册时会遍历该map执行粘性事件的发布，事件发布时默认会考虑事件的继承关系即订阅事件的父类的订阅者也会收到事件。</p>
<p>具体发布过程为：通过单事件，找到所有观察者，遍历所有观察该事件的观察者，执行发布操作，发布时会根据订阅者的线程模型做出不同处理，通过三个发布器 mainThreadPoster,backgroundPoster,asyncPoster  完成四种线程模型的切换，最后通过反射调用观察者。</p>
<h4 id="3-5-注销订阅者流程总结"><a href="#3-5-注销订阅者流程总结" class="headerlink" title="3.5 注销订阅者流程总结"></a>3.5 注销订阅者流程总结</h4><p>注销流程就是先通过订阅者类找所有事件，遍历每一个事件找所有订阅者，判断订阅者中的订阅者类是否和当前类一致，一致就将订阅者中的 active 标记为false 用来阻止继续发布事件，并从内存map中移除。</p>
<h2 id="4-概述"><a href="#4-概述" class="headerlink" title="4. 概述"></a>4. 概述</h2><blockquote>
<p>框架的作用有：隐藏实现细节，降低开发难度，做到代码复用，解耦业务与非业务代码，让程序员聚焦业务开发。</p>
</blockquote>
<p>EventBus 翻译为“事件总线”，它提供了实现观察者模式的骨架代码。我们可以基于此框架，非常容易地在自己的业务场景中实现<strong>观察者模式</strong>，从而减少样板代码。其中，<a href="https://github.com/google/guava/wiki/EventBusExplained" target="_blank" rel="noopener">Google Guava EventBus</a>  就是一个比较著名的 EventBus 框架，它不仅仅支持异步非阻塞模式，同时也支持同步阻塞模式。</p>
<p>而我们今天要分析的 <a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener"><strong>GreenRobot EventBus</strong></a> 是同时适用于 Android 和 Java 平台的事件总线框架，它可简化Activities, Fragments, Threads, Services之间的通信且轻量，它的核心设计理念是对观察者模式（Observer Design Pattern）也被称为发布订阅模式（Publish-Subscribe Design Pattern）的封装。传统的事件传递方式包括：Handler、BroadcastReceiver、Interface回调等，相比之下EventBus的优点是代码简洁，使用简单，并将事件发布和订阅充分解耦。</p>
<blockquote>
<p>*<em>观察者模式 *</em></p>
<p>定义：定义了对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都得到通知并被自动更新。一般情况下，被依赖的对象叫作被观察者（Observable），依赖的对象叫作观察者（Observer）。</p>
<p>作用：解耦观察者和被观察者。</p>
<p>实现：</p>
<ul>
<li><p><strong>同步阻塞</strong>是最经典的实现方式，主要是为了代码解耦；观察者和被观察者代码在同一个线程内执行，被观察者发送更新通知后就一直阻塞着，直到所有的观察者代码都执行完成之后，才会执行后续的代码。</p>
</li>
<li><p><strong>异步非阻塞</strong>除了能实现代码解耦之外，还能提高代码的执行效率；实现方式是被观察者发送更新通知后启动一个新的线程来执行观察者的回调函数。</p>
</li>
</ul>
</blockquote>
<p><strong>EventBus 观察者模式框架 VS 自己实现观察模式</strong></p>
<p>利用 EventBus 框架实现的观察者模式，跟从零开始编写的观察者模式相比，从大的流程上来说，实现思路大致一样，都需要定义观察者（Observer），并且通过 register() 函数注册Observer，也都需要通过调用某个函数（比如，EventBus 中的 post() 函数）来给 Observer 发送消息（在 EventBus 中消息被称作事件 event）。</p>
<p>但在实现细节方面，它们又有些区别。基于 EventBus，我们不需要定义 Observer 接口，任意类型的对象都可以注册到 EventBus 中，通过 @Subscribe 注解来标明类中哪个函数可以接收被观察者发送的消息。</p>
<p>跟经典的观察者模式的不同之处在于，当我们调用 post() 函数发送消息的时候，并非把消息发送给所有的观察者，而是发送给可匹配的观察者。所谓可匹配指的是，能接收的消息类型是发送消息（post 函数定义中的 event）类型或是其父类。</p>
<h2 id="5-工作机制"><a href="#5-工作机制" class="headerlink" title="5. 工作机制"></a>5. 工作机制</h2><p><img src="https://raw.githubusercontent.com/jaydroid1024/jay_image_repo/main/img/20211107112804.png" alt="EventBus-Android-Publish-Subscribe"></p>
<p><strong>发布者(Publisher)</strong>：发布者主动生成事件发布事件给指定订阅者。</p>
<pre class=" language-java"><code class="language-java">EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>事件总线(EventBus)</strong>：统筹所有事件的调度工作，如：收集、注册、切换、分发、解注册等操作。</p>
<pre class=" language-java"><code class="language-java">EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>订阅者(Subscriber)</strong>：声明订阅方法并通过注释标记，可指定线程模式。</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">)</span>  
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessageEvent</span><span class="token punctuation">(</span>MessageEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">/* Do something */</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 id="6-EventBus-优势"><a href="#6-EventBus-优势" class="headerlink" title="6. EventBus 优势"></a>6. EventBus 优势</h2><ul>
<li>简化组件之间的通信，同进程内随便发，组件化中需要考虑 Event Object 的存放位置。</li>
<li>解耦事件的发送者和接收者，仅通过 Event Object 进行链接发送者和接受者。</li>
<li>在 UI 组件和后台线程切换中表现良好的性能</li>
<li>避免复杂且容易出错的依赖关系和生命周期问题，提供解注册订阅者。</li>
<li>很快；专为高性能而优化，很小（~60k jar）</li>
<li><a href="http://www.appbrain.com/stats/libraries/details/eventbus/greenrobot-eventbus" target="_blank" rel="noopener">在实践中被证明通过应用与1,000,000,000+安装</a></li>
<li>具有分发指定线程、设置订阅者优先级等功能。</li>
</ul>
<h2 id="7-EventBus-功能"><a href="#7-EventBus-功能" class="headerlink" title="7. EventBus 功能"></a>7. EventBus 功能</h2><ul>
<li><strong>简单而强大：</strong> EventBus 是一个小型库，其 API 非常容易学习。然而，通过解耦组件，您的软件架构可能会受益匪浅：订阅者在使用事件时并不了解发送者。</li>
<li>实战<strong>测试：</strong> EventBus 是最常用的 Android 库之一：数以千计的应用程序使用 EventBus，包括非常流行的应用程序。超过 10 亿次应用安装不言而喻。</li>
<li><strong>高性能：</strong>尤其是在 Android 上，性能很重要。EventBus 进行了大量分析和优化；可能使其成为同类中最快的解决方案。</li>
<li><strong>方便的基于注释的 API</strong> （不牺牲性能）<strong>：</strong>只需将 @Subscribe 注释放在您的订阅者方法中。由于注释的构建时索引，EventBus 不需要在您的应用程序运行时进行注释反射，这在 Android 上非常慢。</li>
<li><strong>Android 主线程传递：</strong>在与 UI 交互时，EventBus 可以在主线程中传递事件，而不管事件是如何发布的。</li>
<li><strong>后台线程传递：</strong>如果您的订阅者执行长时间运行的任务，EventBus 还可以使用后台线程来避免 UI 阻塞。</li>
<li><strong>事件和订阅者继承：</strong>在 EventBus 中，面向对象的范式适用于事件和订阅者类。假设事件类 A 是 B 的超类。发布的 B 类事件也将发布给对 A 感兴趣的订阅者。类似地考虑订阅者类的继承。</li>
<li><strong>零配置：</strong> 您可以立即开始使用代码中任何位置可用的默认 EventBus 实例。</li>
<li><strong>可配置：</strong> 要根据您的要求调整 EventBus，您可以使用构建器模式调整其行为。</li>
</ul>
<h2 id="8-EventBus-应用"><a href="#8-EventBus-应用" class="headerlink" title="8. EventBus 应用"></a>8. EventBus 应用</h2><ul>
<li>如果使用 EventBus 的页面比较多，可以在 Acitivity/Fragment  基类里面绑定和解绑，并添加一个默认接收事件。</li>
<li>跨界面修改值<ul>
<li>你有一个主界面，里面有一些信息可能会修改，但触发源不在该界面，是在其他的界面触发了一些事件后，首页的内容需要做修改。</li>
<li>如果没有EventBus，也有很多的方式可以实现，譬如定义全局静态变量、或者onResume时获取触发源的值修改界面值、或者定义个CallBack接口传出去等。</li>
<li>譬如微信首页你有未读消息3个时，界面会有3个小红点点，当你点开一个未读消息后，进入了下个界面，那么此时未读消息就是2了，但你并不在首页了，你需要在你打开消息并阅读完毕后通知首页改成2.这就是一种跨界面修改值。</li>
</ul>
</li>
<li>Activity/Fragment 与 Fragment 之间通信</li>
<li>注册页面回退逻辑<ul>
<li>在注册页面填写了手机号、个人信息，传头像操作后，注册成功了，进入了主界面。此时我们需要在主界面关闭之前的注册的所有页面，此时就可以使用eventbus来通知前几个注册用的activity来关闭自己。这样的目的就是当注册失败时，用户按返回键还是能回到填写信息页。当注册成功后，按返回键就直接退出程序，不再保留注册填信息页了。</li>
</ul>
</li>
<li>推送/消息功能<ul>
<li>收到推送后需要不同的页面来做处理的。例如：微信PC登录时，手机端的确认登录页面是可以随时随地弹出的，</li>
</ul>
</li>
<li>组件化通讯<ul>
<li>组件之间的交互，例如：测试环境中环境切换组件，切换后需要重新登录并重置环境信息等。</li>
</ul>
</li>
<li>EventBus最好的使用方式就是替代某些 BroadcastReceiver 和 Interface；如fragment之间进行通信，用广播和接口都比较麻烦，而用EventBus则比较简单。</li>
<li>以下场景可以考虑不用<ul>
<li>Event 会根据传递的参数给所有接收者都传递消息，这就导致如果你想给指定一个类里发布消息就得自己写一个接口类，要不然就会好多执行者都会执行该方法，所以一般能用Intent组件传值时还是用Intent。</li>
<li>EventBus相对于BroadcastReceiver，广播是相对消耗时间、空间最多的一种方式，但是大家都知道，广播是四大组件之一，许多系统级的事件都是通过广播来通知的，比如说网络的变化、电量的变化，短信发送和接收的状态，所以，如果与android系统进行相关的通知，还是要选择本地广播；在BroadcastReceiver的 onReceive方法中，可以获得Context 、intent参数，这两个参数可以调用许多的sdk中的方法，而eventbus获得这两个参数相对比较困难。</li>
<li>EventBus相对于handler，可以实现handler的方式，但是也会面对有许多接收者的问题，所以如果是线程回调的话，我觉得还是用handler比较好。</li>
</ul>
</li>
</ul>
<h2 id="9-EventBus-使用"><a href="#9-EventBus-使用" class="headerlink" title="9. EventBus 使用"></a>9. EventBus 使用</h2><h3 id="9-1-订阅者索引"><a href="#9-1-订阅者索引" class="headerlink" title="9.1 订阅者索引"></a>9.1 订阅者索引</h3><p>使用订阅者索引可以避免在运行时使用反射对订阅者方法进行昂贵的查找。EventBus 注释处理器在编译时查找它们。</p>
<h4 id="符合注解收集的要求"><a href="#符合注解收集的要求" class="headerlink" title="符合注解收集的要求"></a>符合注解收集的要求</h4><ul>
<li>@Subscribe 方法及其类<strong>必须是 public</strong>。</li>
<li>事件类<strong>必须是 public</strong>。</li>
<li>@Subscribe可以<strong>不</strong>被使用<strong>匿名类的内部</strong>。</li>
<li>当 EventBus 不能使用索引时，例如不满足上述要求，它会在运行时降级为通过反射查找订阅者。这确保@Subscribe 方法接收事件，即使它们不是索引的一部分。</li>
</ul>
<h4 id="配置注解处理器"><a href="#配置注解处理器" class="headerlink" title="配置注解处理器"></a>配置注解处理器</h4><pre class=" language-groovy"><code class="language-groovy"><span class="token comment" spellcheck="true">//java</span>
android <span class="token punctuation">{</span>
    defaultConfig <span class="token punctuation">{</span>
        javaCompileOptions <span class="token punctuation">{</span>
            annotationProcessorOptions <span class="token punctuation">{</span>
                arguments <span class="token operator">=</span> <span class="token punctuation">[</span> eventBusIndex <span class="token punctuation">:</span> <span class="token string">'com.example.myapp.MyEventBusIndex'</span> <span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

dependencies <span class="token punctuation">{</span>
    <span class="token keyword">def</span> eventbus_version <span class="token operator">=</span> <span class="token string">'3.2.0'</span>
    implementation <span class="token string">"org.greenrobot:eventbus:$eventbus_version"</span>
    annotationProcessor <span class="token string">"org.greenrobot:eventbus-annotation-processor:$eventbus_version"</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//kotlin </span>
apply plugin<span class="token punctuation">:</span> <span class="token string">'kotlin-kapt'</span> <span class="token comment" spellcheck="true">// ensure kapt plugin is applied</span>

dependencies <span class="token punctuation">{</span>
    <span class="token keyword">def</span> eventbus_version <span class="token operator">=</span> <span class="token string">'3.2.0'</span>
    implementation <span class="token string">"org.greenrobot:eventbus:$eventbus_version"</span>
    kapt <span class="token string">"org.greenrobot:eventbus-annotation-processor:$eventbus_version"</span>
<span class="token punctuation">}</span>

kapt <span class="token punctuation">{</span>
    arguments <span class="token punctuation">{</span>
        <span class="token function">arg</span><span class="token punctuation">(</span><span class="token string">'eventBusIndex'</span><span class="token punctuation">,</span> <span class="token string">'com.example.myapp.MyEventBusIndex'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="使用订阅者索引类"><a href="#使用订阅者索引类" class="headerlink" title="使用订阅者索引类"></a>使用订阅者索引类</h4><p>在您的<em>Application</em>类中，使用<em>EventBus.builder().addIndex(indexInstance)</em>将索引类的实例传递给 EventBus。组件中的索引类也可以通过addIndex方法添加到 EventBus 实例中。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//创建一个新实例并配置索引类</span>
<span class="token keyword">val</span> eventBus <span class="token operator">=</span> EventBus<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token function">MyEventBusIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//使用单例模式并配置索引类</span>
EventBus<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token function">MyEventBusIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">installDefaultEventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// Now the default instance uses the given index. Use it like this:</span>
<span class="token keyword">val</span> eventBus <span class="token operator">=</span> EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h4 id="防止混淆订阅者"><a href="#防止混淆订阅者" class="headerlink" title="防止混淆订阅者"></a>防止混淆订阅者</h4><pre class=" language-java"><code class="language-java"><span class="token operator">-</span>keepattributes <span class="token operator">*</span>Annotation<span class="token operator">*</span>
<span class="token operator">-</span>keepclassmembers <span class="token keyword">class</span> <span class="token operator">*</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@org</span><span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>eventbus<span class="token punctuation">.</span>Subscribe <span class="token operator">&lt;</span>methods<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span>keep <span class="token keyword">enum</span> org<span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>eventbus<span class="token punctuation">.</span>ThreadMode <span class="token punctuation">{</span> <span class="token operator">*</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

# And <span class="token keyword">if</span> you use AsyncExecutor<span class="token operator">:</span>
<span class="token operator">-</span>keepclassmembers <span class="token keyword">class</span> <span class="token operator">*</span> <span class="token keyword">extends</span> <span class="token class-name">org<span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>eventbus<span class="token punctuation">.</span>util<span class="token punctuation">.</span>ThrowableFailureEvent</span> <span class="token punctuation">{</span>
    <span class="token operator">&lt;</span>init<span class="token operator">></span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="9-2-配置EventBus"><a href="#9-2-配置EventBus" class="headerlink" title="9.2 配置EventBus"></a>9.2 配置EventBus</h3><p>EventBusBuilder 类可以配置 EventBus 的各个方面。例如</p>
<p>使用 EventBus.getDefault() 是一种从应用程序中的任何位置获取共享 EventBus 实例的简单方法。EventBusBuilder 还允许使用installDefaultEventBus ( )方法配置此默认实例。可以在 Application 类中在使用 EventBus 之前配置默认 EventBus 实例。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> App <span class="token operator">:</span> <span class="token function">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        EventBus<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//将此与 BuildConfig.DEBUG 一起使用可让应用程序尽在在 DEBUG 模式下崩溃。默认为false</span>
            <span class="token comment" spellcheck="true">// 这样就不会在开发过程中错过异常（Invoking subscriber failed）</span>
            <span class="token punctuation">.</span><span class="token function">throwSubscriberException</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">//如果发送了没有订阅者的event,是否需要打印提示哪一个 event bean 的log,默认为true</span>
            <span class="token comment" spellcheck="true">//提示信息： No subscribers registered for event class org.greenrobot.eventbusperf.jay.bus.SubEvent</span>
            <span class="token punctuation">.</span><span class="token function">logNoSubscriberMessages</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">installDefaultEventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="9-3-ThreadMode"><a href="#9-3-ThreadMode" class="headerlink" title="9.3 ThreadMode"></a>9.3 ThreadMode</h3><p>在 EventBus 中，您可以使用四种 ThreadMode 来指定订阅者方法所在的线程。</p>
<ul>
<li><a href="https://greenrobot.org/eventbus/documentation/delivery-threads-threadmode/#ThreadMode_POSTING" target="_blank" rel="noopener">1 ThreadMode: POSTING</a> ：发布者和订阅者在同一个线程。<ul>
<li>这是默认设置。事件传递是同步完成的，需要注意避免阻塞主线程。</li>
<li>避免了线程切换意味着开销较小。</li>
</ul>
</li>
<li><a href="https://greenrobot.org/eventbus/documentation/delivery-threads-threadmode/#ThreadMode_MAIN" target="_blank" rel="noopener">2 ThreadMode: MAIN</a> ：订阅者将在 Android 的主线程（UI 线程）中调用。<ul>
<li>事件传递是同步完成的，需要注意避免阻塞主线程。</li>
</ul>
</li>
<li><a href="https://greenrobot.org/eventbus/documentation/delivery-threads-threadmode/#ThreadMode_MAIN_ORDERED" target="_blank" rel="noopener">3 ThreadMode: MAIN_ORDERED</a> ：订阅者将在 Android 的主线程中被调用，该事件总是通过Handler排队等待稍后传递给订阅者。<ul>
<li>为事件处理提供了更严格和更一致的顺序。</li>
<li>如果前一个也是main_ordered 需要等前一个执行完成后才执行。</li>
<li>事件传递是异步完成的。</li>
</ul>
</li>
<li><a href="https://greenrobot.org/eventbus/documentation/delivery-threads-threadmode/#ThreadMode_BACKGROUND" target="_blank" rel="noopener">4 ThreadMode: BACKGROUND</a> ：如果发帖线程非主线程则订阅者的处理会在工作线程中执行否则和发布者同一个线程处理。<ul>
<li>事件传递是异步完成的。</li>
</ul>
</li>
<li><a href="https://greenrobot.org/eventbus/documentation/delivery-threads-threadmode/#ThreadMode_ASYNC" target="_blank" rel="noopener">5 ThreadMode: ASYNC</a> ：无论事件在哪个线程发布，订阅者都会在新建的工作线程中执行。<ul>
<li>EventBus 使用线程池来有效地重用线程。</li>
<li>事件传递是异步完成的。</li>
<li>如果事件处理程序方法的执行可能需要一些时间，则应使用此模式，例如用于网络访问</li>
</ul>
</li>
</ul>
<pre class=" language-kotlin"><code class="language-kotlin"> <span class="token comment" spellcheck="true">//在主线程发消息</span>
 发布者所在线程<span class="token operator">:</span>Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> BACKGROUND 
 发布者所在线程<span class="token operator">:</span>Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> ASYNC 
 发布者所在线程<span class="token operator">:</span>Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> POSTING 
 发布者所在线程<span class="token operator">:</span>Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN 
 发布者所在线程<span class="token operator">:</span>Thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN_ORDERED 
 <span class="token comment" spellcheck="true">//在子线程发消息</span>
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> BACKGROUND 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> pool<span class="token operator">-</span><span class="token number">1</span><span class="token operator">-</span>thread<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> ASYNC 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> POSTING 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN_ORDERED </code></pre>
<h3 id="9-4-订阅者优先级"><a href="#9-4-订阅者优先级" class="headerlink" title="9.4 订阅者优先级"></a>9.4 订阅者优先级</h3><p>订阅者优先级影响事件传递的顺序。 在同一个交付线程 ( ThreadMode ) 中，较高优先级的订阅者将在其他具有较低优先级的订阅者之前收到事件。 默认优先级为 0。注意：优先级不影响具有不同ThreadMode的订阅者之间的传递顺序！</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>POSTING<span class="token punctuation">,</span> priority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onMessageEvent_POSTING1</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"POSTING1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>POSTING<span class="token punctuation">,</span> priority <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onMessageEvent_POSTING2</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"POSTING2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">,</span> priority <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onMessageEvent_MAIN1</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"MAIN1"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">,</span> priority <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onMessageEvent_MAIN2</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"MAIN2"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

 <span class="token comment" spellcheck="true">//打印结果</span>
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> POSTING2 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN2 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> POSTING1 
 发布者所在线程<span class="token operator">:</span>main<span class="token punctuation">,</span> 订阅者所在线程<span class="token operator">:</span> main<span class="token punctuation">,</span> 订阅者线程模式<span class="token operator">:</span> MAIN1 </code></pre>
<p><strong>取消事件传递</strong></p>
<p>您可以通过从订阅者的事件处理方法调用cancelEventDelivery ( Object event ) 来取消事件传递过程。任何进一步的事件传递都将被取消，后续订阅者将不会收到该事件。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Prevent delivery to other subscribers*</span>
EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cancelEventDelivery</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">;</span></code></pre>
<p>事件通常由更高优先级的订阅者取消。取消仅限于在发布线程 ( ThreadMode . PostThread ) 中运行的事件处理方法。</p>
<h3 id="9-5-粘性事件"><a href="#9-5-粘性事件" class="headerlink" title="9.5 粘性事件"></a>9.5 粘性事件</h3><p>普通事件都是需要先注册(register)，再post才能接受到事件；如果你使用 postSticky 发送事件，那么可以不需要先注册，也能接受到事件，也就是一个延迟注册的过程。 </p>
<p>普通的事件我们通过post发送给EventBus，发送过后之后当前已经订阅过的方法可以收到。但是如果有些事件需要所有订阅了该事件的方法都能执行呢？例如一个Activity，要求它管理的所有Fragment都能执行某一个事件，但是当前我只初始化了3个Fragment，如果这时候通过post发送了事件，那么当前的3个Fragment当然能收到。但是这个时候又初始化了2个Fragment，那么我必须重新发送事件，这两个Fragment才能执行到订阅方法。 </p>
<p>粘性事件就是为了解决这个问题，通过 postSticky 发送粘性事件，这个事件不会只被消费一次就消失，而是一直存在系统中，直到被 removeStickyEvent 删除掉。那么只要订阅了该粘性事件的所有方法，只要被register 的时候就会被检测到并且执行。订阅的方法需要添加 sticky = true 属性。</p>
<pre class=" language-kotlin"><code class="language-kotlin">EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postSticky</span><span class="token punctuation">(</span><span class="token function">MessageEvent</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//消费粘性事件方式一：</span>
<span class="token keyword">val</span> stickyEvent <span class="token operator">=</span> EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStickyEvent</span><span class="token punctuation">(</span>MessageEvent<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 最好检查之前是否实际发布过事件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stickyEvent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 消费掉粘性事件</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeStickyEvent</span><span class="token punctuation">(</span>stickyEvent<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//消费粘性事件方式二：</span>
<span class="token keyword">val</span> stickyEvent2 <span class="token operator">=</span> EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeStickyEvent</span><span class="token punctuation">(</span>MessageEvent<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// 最好检查之前是否实际发布过事件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>stickyEvent2 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//已经消费了</span>
<span class="token punctuation">}</span>

<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">,</span> sticky <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">onMessageEvent_sticky</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"MAIN"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//消费粘性事件方式三：</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeStickyEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="9-6-异步执行器"><a href="#9-6-异步执行器" class="headerlink" title="9.6 异步执行器"></a>9.6 异步执行器</h3><p>AsyncExecutor 就像一个线程池，但具有失败（异常）处理功能。失败会引发异常，AsyncExecutor 会将这些异常包装在一个事件中，该事件会自动发布。</p>
<p> <em>AsyncExecutor 是一个非核心实用程序类。它可能会为您节省一些在后台线程中进行错误处理的代码，但它不是核心 EventBus 类。</em></p>
<p>调用 AsyncExecutor.create() 来创建一个实例并将其保存在应用程序范围内。然后要执行某些操作，请实现 RunnableEx接口并将其传递给AsyncExecutor的execute方法。与Runnable不同，RunnableEx可能抛出异常。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//AsyncExecutor类似于线程池，但具有失败(异常)处理。失败是抛出异常，AsyncExecutor将把这些异常封装在一个事件中，该事件将自动发布。</span>
AsyncExecutor<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span> <span class="token punctuation">{</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">postSticky</span><span class="token punctuation">(</span>SubEvent<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//线程池中发出的时间</span>
<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">handleLoginEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> SubEvent<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//线程池中任务异常时发出的时间</span>
<span class="token annotation builtin">@Subscribe</span><span class="token punctuation">(</span>threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>MAIN<span class="token punctuation">)</span>
<span class="token keyword">fun</span> <span class="token function">handleFailureEvent</span><span class="token punctuation">(</span>event<span class="token operator">:</span> ThrowableFailureEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// do something</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="10-EventBus-原理"><a href="#10-EventBus-原理" class="headerlink" title="10 EventBus 原理"></a>10 EventBus 原理</h2><p>了解框架之前我们先定义几个核心角色用于描述整个流程</p>
<ul>
<li><p>发布者类：调用 post/postSticky 发布事件的类</p>
</li>
<li><p>发布者方法：调用 post/postSticky 发布事件的方法</p>
</li>
<li><p>事件类： post/postSticky 方法参数类以及订阅者方法参数类型</p>
</li>
<li><p>订阅者类：订阅者方法所在的类</p>
</li>
<li><p>订阅者方法：通过注解标注的订阅者方法</p>
</li>
</ul>
<p><img src="https://raw.githubusercontent.com/jaydroid1024/jay_image_repo/main/img/20211111000627.png" alt="image-20211111000620374"></p>
<h3 id="10-1-编译时部分-通过-APT-收集订阅者注解并生成索引类"><a href="#10-1-编译时部分-通过-APT-收集订阅者注解并生成索引类" class="headerlink" title="10.1 编译时部分-通过 APT 收集订阅者注解并生成索引类"></a>10.1 编译时部分-通过 APT 收集订阅者注解并生成索引类</h3><p>注解类 Subscribe 用于标注订阅者方法</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">Subscribe</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//用来指定指定订阅者方法所在的线程。</span>
    ThreadMode <span class="token function">threadMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> ThreadMode<span class="token punctuation">.</span>POSTING<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//如果为 true，则将最近的粘性事件（通过EventBus.postSticky(Object) ）传递给该订阅者。</span>
    <span class="token keyword">boolean</span> <span class="token function">sticky</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//订阅者优先级影响事件传递的顺序。</span>
    <span class="token comment" spellcheck="true">// 在同一个交付线程 ( ThreadMode ) 中，较高优先级的订阅者将在其他具有较低优先级的订阅者之前收到事件。 默认优先级为 0。</span>
    <span class="token comment" spellcheck="true">// 注意：优先级不会影响具有不同ThreadMode的订阅者之间的传递顺序！</span>
    <span class="token keyword">int</span> <span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>收集那些代码元素：订阅者类&amp;订阅者方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">BusTestActivity</span> <span class="token operator">:</span> <span class="token function">Activity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//定义一个订阅者方法</span>
    <span class="token annotation punctuation">@Subscribe</span><span class="token punctuation">(</span>sticky <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> threadMode <span class="token operator">=</span> ThreadMode<span class="token punctuation">.</span>POSTING<span class="token punctuation">,</span> priority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    fun <span class="token function">onMessageEvent_POSTING1</span><span class="token punctuation">(</span>event<span class="token operator">:</span> MessageEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">showMsg</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">"POSTING1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>注解处理器通过继承 Java AbstractProcessor 抽象类并配置注解和选项参数实现</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SupportedAnnotationTypes</span><span class="token punctuation">(</span><span class="token string">"org.greenrobot.eventbus.Subscribe"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SupportedOptions</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"eventBusIndex"</span><span class="token punctuation">,</span> <span class="token string">"verbose"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@IncrementalAnnotationProcessor</span><span class="token punctuation">(</span>AGGREGATING<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventBusAnnotationProcessor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractProcessor</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>通过处理器参数获取配置的订阅者索引全类名，没有配置该参数但是却依赖了注解处理组件会抛异常</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//设置apt参数</span>
javaCompileOptions <span class="token punctuation">{</span>
    annotationProcessorOptions <span class="token punctuation">{</span>
        arguments <span class="token operator">=</span> <span class="token punctuation">[</span>
                eventBusIndex<span class="token operator">:</span> <span class="token string">'org.greenrobot.eventbusperf.MyEventBusIndex'</span><span class="token punctuation">,</span>
                verbose<span class="token operator">:</span> <span class="token string">'true'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//获取apt参数</span>
String index <span class="token operator">=</span> processingEnv<span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>OPTION_EVENT_BUS_INDEX<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>Diagnostic<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token string">"No option "</span> <span class="token operator">+</span> OPTION_EVENT_BUS_INDEX <span class="token operator">+</span>
            <span class="token string">" passed to annotation processor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//没有配置的错误信息</span>
<span class="token operator">></span> Task <span class="token operator">:</span>EventBusPerformance<span class="token operator">:</span>compileDebugJavaWithJavac FAILED
错误<span class="token operator">:</span> No option eventBusIndex passed to annotation processor</code></pre>
<ul>
<li>收集注解流程</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">collectSubscribers</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">TypeElement</span><span class="token operator">></span> annotations<span class="token punctuation">,</span> RoundEnvironment env<span class="token punctuation">,</span> Messager messager<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>TypeElement annotation <span class="token operator">:</span> annotations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取目标注解标注的所有元素，这里是所有的订阅者方法</span>
        Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Element</span><span class="token operator">></span> elements <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">getElementsAnnotatedWith</span><span class="token punctuation">(</span>annotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Element element <span class="token operator">:</span> elements<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//ExecutableElement 可执行元素指的是方法类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token keyword">instanceof</span> <span class="token class-name">ExecutableElement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ExecutableElement method <span class="token operator">=</span> <span class="token punctuation">(</span>ExecutableElement<span class="token punctuation">)</span> element<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//检查方法:正好只有一个参数的非静态的公开的方法</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkHasNoErrors</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> messager<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//获取方法所在的类元素</span>
                    TypeElement classElement <span class="token operator">=</span> <span class="token punctuation">(</span>TypeElement<span class="token punctuation">)</span> method<span class="token punctuation">.</span><span class="token function">getEnclosingElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//存入容器</span>
                    methodsByClass<span class="token punctuation">.</span><span class="token function">putElement</span><span class="token punctuation">(</span>classElement<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>Diagnostic<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> <span class="token string">"@Subscribe is only valid for methods"</span><span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>校验某个类对索引类包是否可访问</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isVisible</span><span class="token punctuation">(</span>String myPackage<span class="token punctuation">,</span> TypeElement typeElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//类的修饰符</span>
    Set<span class="token operator">&lt;</span>Modifier<span class="token operator">></span> modifiers <span class="token operator">=</span> typeElement<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> visible<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Modifier<span class="token punctuation">.</span>PUBLIC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>modifiers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Modifier<span class="token punctuation">.</span>PRIVATE<span class="token punctuation">)</span> <span class="token operator">||</span> modifiers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>Modifier<span class="token punctuation">.</span>PROTECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//类所在的包</span>
        String subscriberPackage <span class="token operator">=</span> <span class="token function">getPackageElement</span><span class="token punctuation">(</span>typeElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//处理器参数没有指定索引类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>myPackage <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//todo 没有包名什么情况</span>
            visible <span class="token operator">=</span> subscriberPackage<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//索引类和观察者包名一样</span>
            visible <span class="token operator">=</span> myPackage<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>subscriberPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> visible<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>校验收集到的注解元素信息是否符合预期</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkForSubscribersToSkip</span><span class="token punctuation">(</span>Messager messager<span class="token punctuation">,</span> String myPackage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//遍历所有订阅者方法所在的类</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>TypeElement skipCandidate <span class="token operator">:</span> methodsByClass<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//方法所在的类，</span>
        TypeElement subscriberClass <span class="token operator">=</span> skipCandidate<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//循环获取父类</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>subscriberClass <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//所有观察者</span>
            <span class="token comment" spellcheck="true">//校验某个类类对索引类包是否可访问</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVisible</span><span class="token punctuation">(</span>myPackage<span class="token punctuation">,</span> subscriberClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//索引类访问不到观察者类，跳过</span>
                <span class="token keyword">boolean</span> added <span class="token operator">=</span> classesToSkip<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>skipCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//存在不可访问观察者</span>
                    String msg<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//由于类不是公开的，所以回退到反射</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriberClass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skipCandidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//没有继承关系存在</span>
                        msg <span class="token operator">=</span> <span class="token string">"Falling back to reflection because class is not public"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//父类</span>
                        msg <span class="token operator">=</span> <span class="token string">"Falling back to reflection because "</span> <span class="token operator">+</span> skipCandidate <span class="token operator">+</span>
                                <span class="token string">" has a non-public super class"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>Diagnostic<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>NOTE<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//观察者类中的所有观察方法</span>
            List<span class="token operator">&lt;</span>ExecutableElement<span class="token operator">></span> methods <span class="token operator">=</span> methodsByClass<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>methods <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>ExecutableElement method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String skipReason <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//方法第一个参数</span>
                    VariableElement param <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//参数类型</span>
                    TypeMirror typeMirror <span class="token operator">=</span> <span class="token function">getParamTypeMirror</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> messager<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//不是类类型报错</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>typeMirror <span class="token keyword">instanceof</span> <span class="token class-name">DeclaredType</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DeclaredType<span class="token punctuation">)</span> typeMirror<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">TypeElement</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        skipReason <span class="token operator">=</span> <span class="token string">"event type cannot be processed"</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">//是类类型但是对索引类不可见</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipReason <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        TypeElement eventTypeElement <span class="token operator">=</span> <span class="token punctuation">(</span>TypeElement<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DeclaredType<span class="token punctuation">)</span> typeMirror<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">//参数类对索引类不可见</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isVisible</span><span class="token punctuation">(</span>myPackage<span class="token punctuation">,</span> eventTypeElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            skipReason <span class="token operator">=</span> <span class="token string">"event type is not public"</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">//存在观察者方法但是不可见先存下来，用于过滤</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>skipReason <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">boolean</span> added <span class="token operator">=</span> classesToSkip<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>skipCandidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            String msg <span class="token operator">=</span> <span class="token string">"Falling back to reflection because "</span> <span class="token operator">+</span> skipReason<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriberClass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>skipCandidate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                msg <span class="token operator">+=</span> <span class="token string">" (found in super class for "</span> <span class="token operator">+</span> skipCandidate <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            messager<span class="token punctuation">.</span><span class="token function">printMessage</span><span class="token punctuation">(</span>Diagnostic<span class="token punctuation">.</span>Kind<span class="token punctuation">.</span>NOTE<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> param<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//获取观察者类的父类，继续循环</span>
            subscriberClass <span class="token operator">=</span> <span class="token function">getSuperclass</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>将收集到的索引信息写入索引类中的 map 容器中</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeIndexLines</span><span class="token punctuation">(</span>BufferedWriter writer<span class="token punctuation">,</span> String myPackage<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>TypeElement subscriberTypeElement <span class="token operator">:</span> methodsByClass<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//只生成可访问的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>classesToSkip<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>subscriberTypeElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String subscriberClass <span class="token operator">=</span> <span class="token function">getClassString</span><span class="token punctuation">(</span>subscriberTypeElement<span class="token punctuation">,</span> myPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isVisible</span><span class="token punctuation">(</span>myPackage<span class="token punctuation">,</span> subscriberTypeElement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">writeLine</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    <span class="token string">"putIndex(new SimpleSubscriberInfo("</span> <span class="token operator">+</span> subscriberClass <span class="token operator">+</span> <span class="token string">".class,"</span><span class="token punctuation">,</span>
                    <span class="token string">"true,"</span><span class="token punctuation">,</span> <span class="token string">"new SubscriberMethodInfo[] {"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            List<span class="token operator">&lt;</span>ExecutableElement<span class="token operator">></span> methods <span class="token operator">=</span> methodsByClass<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriberTypeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">writeCreateSubscriberMethods</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> <span class="token string">"new SubscriberMethodInfo"</span><span class="token punctuation">,</span> myPackage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"        }));\n\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"        // Subscriber not visible to index: "</span> <span class="token operator">+</span> subscriberClass <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<ul>
<li>生成的 MyEventBusIndex 文件</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//通过注释处理创建的生成索引类的接口。</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">SubscriberInfo</span> <span class="token punctuation">{</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">getSubscriberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SubscriberMethod<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getSubscriberMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SubscriberInfo <span class="token function">getSuperSubscriberInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> <span class="token function">shouldCheckSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyEventBusIndex</span> <span class="token keyword">implements</span> <span class="token class-name">SubscriberInfoIndex</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> SubscriberInfo<span class="token operator">></span> SUBSCRIBER_INDEX<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        SUBSCRIBER_INDEX <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> SubscriberInfo<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">putIndex</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleSubscriberInfo</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>greenrobot<span class="token punctuation">.</span>eventbusperf<span class="token punctuation">.</span>testsubject<span class="token punctuation">.</span>PerfTestEventBus<span class="token punctuation">.</span>SubscriberClassEventBusAsync<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SubscriberMethodInfo</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">SubscriberMethodInfo</span><span class="token punctuation">(</span><span class="token string">"onEventAsync"</span><span class="token punctuation">,</span> TestEvent<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ThreadMode<span class="token punctuation">.</span>ASYNC<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//其它索引信息......</span>
      <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">putIndex</span><span class="token punctuation">(</span>SubscriberInfo info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SUBSCRIBER_INDEX<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span><span class="token function">getSubscriberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> SubscriberInfo <span class="token function">getSubscriberInfo</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    SubscriberInfo info <span class="token operator">=</span> SUBSCRIBER_INDEX<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="编译时APT流程总结"><a href="#编译时APT流程总结" class="headerlink" title="编译时APT流程总结"></a>编译时APT流程总结</h4><p>EventBus 中订阅者的收集是通过两种方式，一种是运行时反射收集，另一种是通过注解处理器收集。通过apt收集相比通过运行时反射的方式可以减少因为反射带来的性能开销，但是会影响编译时的时间。综合考量必然还是推荐通过APT方式。</p>
<p>通过APT方式收集订阅者的大体流程如下：</p>
<ul>
<li>在编码阶段添加订阅者方法时我们需要通过 <strong>@Subscribe</strong> 注解类标注订阅者，该注解类提供三个参数用来个性化配置订阅者，三个参数分别是：<strong>enum ThreadMode、boolean sticky，int priority</strong> 。注解处理器所做的工作就是收集订阅者方法以及这些方法所在的类信息。</li>
<li>EventBus 规定生成的索引类的全类名是由开发者自行定义传入的，所以在编译之前还模块的 build.gradle 中需要配置索引类，否则会编译错误。</li>
<li>注解处理器注解处理流程主要分为：<strong>收集订阅者、校验订阅者、生成索引类</strong>三个过程。<ul>
<li>收集订阅者：遍历所有可执行元素 ExecutableElement，校验订阅者方法签名，订阅者方法签名需要满足 <strong>正好只有一个参数的非静态的公开的方法</strong> 的规则。然后将找到的订阅者方法和订阅者类存入 *<em>ListMap&lt;TypeElement, ExecutableElement&gt; methodsByClass *</em>  容器中。该容器的数据结构是：<code>HashMap&lt;K, List&lt;V&gt;&gt;()</code> key 存入的是订阅者类，value 是该类中所有订阅者方法的集合。</li>
<li>校验订阅者（包括订阅者类/订阅者类的父类和订阅者方法）：<ul>
<li>校验订阅者类：遍历所有上一步收集到的订阅者类，校验订阅者类，订阅者类需要满足<strong>public/default+索引类和订阅者类的包名一样</strong> 的规则，不满足的订阅者类需要添加到 <strong>Set<typeelement> classesToSkip</typeelement></strong> 容器中标记。</li>
<li>校验订阅者类中的方法：满足上一步的订阅者类中任何一个订阅者方法满足以下情况的直接将对应的订阅者类需要添加到 <strong>Set<typeelement> classesToSkip</typeelement></strong> 容器中标记。<ul>
<li>订阅者方法的参数类型(也就是Event 类型)不是 DeclaredType 或者是 DeclaredType 但不是 TypeElement。</li>
<li>订阅者方法的参数类型是类类型但是对索引类不可见。</li>
</ul>
</li>
</ul>
</li>
<li>生成索引类：遍历最终收集到的 <strong>methodsByClass</strong> 订阅者信息通过字符串拼接的方式生成索引类。这里换成Javapoet的方式更容易维护，EventBus 可能是为了节省框架包的体积没有采用Javapoet的方式生成java文件。</li>
</ul>
</li>
</ul>
<h3 id="10-2-运行时部分-初始化、注册-查找订阅者等"><a href="#10-2-运行时部分-初始化、注册-查找订阅者等" class="headerlink" title="10.2 运行时部分-初始化、注册/查找订阅者等"></a>10.2 运行时部分-初始化、注册/查找订阅者等</h3><h4 id="10-2-1-初始化EventBus"><a href="#10-2-1-初始化EventBus" class="headerlink" title="10.2.1 初始化EventBus"></a>10.2.1 初始化EventBus</h4><p>构建 EventBus 实例的三种方式：</p>
<ul>
<li><p>EventBus.getDefault() + 默认Builder</p>
</li>
<li><p>EventBus.builder().installDefaultEventBus() + 自定义配置</p>
</li>
<li><p>EventBus.builder().build() + 自定义配置</p>
</li>
</ul>
<p>方式一：DCL单例方式创建进程唯一实例</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">volatile</span> EventBus defaultInstance<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//使用进程范围的 EventBus 实例的应用程序的便捷单例。</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> EventBus <span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//通过局部变量中转可节省性能</span>
    EventBus instance <span class="token operator">=</span> defaultInstance<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>EventBus<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            instance <span class="token operator">=</span> EventBus<span class="token punctuation">.</span>defaultInstance<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                instance <span class="token operator">=</span> EventBus<span class="token punctuation">.</span>defaultInstance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>其它两种方式</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//EventBus.builder().build() + 自定义配置</span>
EventBus<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">throwSubscriberException</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">logNoSubscriberMessages</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//添加索引类，减少运行时反射</span>
    <span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token function">MyEventBusIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">public</span> EventBus <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EventBus</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//EventBus.builder().installDefaultEventBus() + 自定义配置</span>
EventBus<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">throwSubscriberException</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">logNoSubscriberMessages</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">//添加索引类，减少运行时反射</span>
    <span class="token punctuation">.</span><span class="token function">addIndex</span><span class="token punctuation">(</span><span class="token function">MyEventBusIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">installDefaultEventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">public</span> EventBus <span class="token function">installDefaultEventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>EventBus<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>EventBus<span class="token punctuation">.</span>defaultInstance <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span><span class="token string">"Default instance already exists."</span> <span class="token operator">+</span>
                    <span class="token string">" It may be only set once before it's used the first time to ensure consistent behavior."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        EventBus<span class="token punctuation">.</span>defaultInstance <span class="token operator">=</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> EventBus<span class="token punctuation">.</span>defaultInstance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>构建EventBus时的默认配置</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token function">EventBus</span><span class="token punctuation">(</span>EventBusBuilder builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//通过事件类找所有该事件的订阅者，</span>
    subscriptionsByEventType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//通过订阅者类找所有Event</span>
    typesBySubscriber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//通过粘性事件类查找所有粘性事件对象</span>
    stickyEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//构建 AndroidHandlerMainThreadSupport</span>
    mainThreadSupport <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">getMainThreadSupport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//构建 HandlerPoster</span>
    mainThreadPoster <span class="token operator">=</span> mainThreadSupport <span class="token operator">!=</span> null <span class="token operator">?</span> mainThreadSupport<span class="token punctuation">.</span><span class="token function">createPoster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在后台发布事件</span>
    backgroundPoster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BackgroundPoster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在后台发布事件</span>
    asyncPoster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncPoster</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    indexCount <span class="token operator">=</span> builder<span class="token punctuation">.</span>subscriberInfoIndexes <span class="token operator">!=</span> null <span class="token operator">?</span> builder<span class="token punctuation">.</span>subscriberInfoIndexes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//通过反射或APT查找订阅者</span>
    subscriberMethodFinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SubscriberMethodFinder</span><span class="token punctuation">(</span>
            <span class="token comment" spellcheck="true">//添加由 EventBus 的注释预处理器生成的索引。默认空集合</span>
            builder<span class="token punctuation">.</span>subscriberInfoIndexes<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//启用严格的方法验证（默认值：false）</span>
            builder<span class="token punctuation">.</span>strictMethodVerification<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">//即使有生成的索引也强制使用反射（默认值：false）</span>
            builder<span class="token punctuation">.</span>ignoreGeneratedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//无法分发事件时是否打印错误信息</span>
    logSubscriberExceptions <span class="token operator">=</span> builder<span class="token punctuation">.</span>logSubscriberExceptions<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//没有订阅者注册事件是否打印错误信息</span>
    logNoSubscriberMessages <span class="token operator">=</span> builder<span class="token punctuation">.</span>logNoSubscriberMessages<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在调用订阅者时如果发生异常是否 发送一个 SubscriberExceptionEvent 通知订阅者</span>
    sendSubscriberExceptionEvent <span class="token operator">=</span> builder<span class="token punctuation">.</span>sendSubscriberExceptionEvent<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//没有订阅者注册事件是否是否通知订阅者类的父类</span>
    sendNoSubscriberEvent <span class="token operator">=</span> builder<span class="token punctuation">.</span>sendNoSubscriberEvent<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//在调用订阅者时如果发生异常是否抛出 RuntimeException</span>
    throwSubscriberException <span class="token operator">=</span> builder<span class="token punctuation">.</span>throwSubscriberException<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//是否通知订阅者类的父类中的订阅者方法</span>
    eventInheritance <span class="token operator">=</span> builder<span class="token punctuation">.</span>eventInheritance<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//订阅者执行在工作线程时用到的线程池：Executors.newCachedThreadPool()</span>
    executorService <span class="token operator">=</span> builder<span class="token punctuation">.</span>executorService<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="初始化EventBus-总结"><a href="#初始化EventBus-总结" class="headerlink" title="初始化EventBus 总结"></a>初始化EventBus 总结</h5><p>总的来说 EventBus 的初始化流程不是很复杂， EventBus 对象的创建结合了单例模式和构建者模式。</p>
<p>单例模式常用于构建全局唯一类并提供全局唯一访问点。</p>
<p>构建者模式常用于构建可以通过设置不同的可选参数，定制化地创建一个复杂对象。</p>
<p>EventBus 恰好需要全局唯一且配置复杂，此时就可以结合两个设计模式应对不同的构建场景。</p>
<p>需要全局唯一默认配置的实例直接通过单例获取，需要为前面的单例个性化定制也可以通过构建者模式配置参数。</p>
<p>你自己维护全局唯一或者需要局部唯一的场景也可以通过构建者模式个性化定制。</p>
<p>可能是因为 EventBus  的应用场景多样，他的DCL单例模式并没有显示私有构造方法和静态实例变量，也就是说直接 new EventBus 也是可以的。</p>
<h4 id="10-2-2-注册订阅者：查找订阅者方法"><a href="#10-2-2-注册订阅者：查找订阅者方法" class="headerlink" title="10.2.2 注册订阅者：查找订阅者方法"></a>10.2.2 注册订阅者：查找订阅者方法</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> override fun <span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//注册给定的订阅者以接收事件。 订阅者一旦对接收事件不再感兴趣，须调用 unregister(Object) 。</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>Object subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass <span class="token operator">=</span> subscriber<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//通过订阅者类找出该类中所有的订阅者方法</span>
    List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> subscriberMethods <span class="token operator">=</span> subscriberMethodFinder<span class="token punctuation">.</span><span class="token function">findSubscriberMethods</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//01</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SubscriberMethod subscriberMethod <span class="token operator">:</span> subscriberMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">subscribe</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">,</span> subscriberMethod<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//02</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>01查找订阅者方法流程：通过APT或反射方式查找订阅者方法并内存缓存</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//ConcurrentHashMap 内存缓存保证线程安全</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">>></span> METHOD_CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//通过订阅者类查找订阅者方法</span>
List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> <span class="token function">findSubscriberMethods</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//先从内存缓存尝试取，节省查找开销</span>
    List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> subscriberMethods <span class="token operator">=</span> METHOD_CACHE<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriberMethods <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> subscriberMethods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ignoreGeneratedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//运行时反射查找</span>
        subscriberMethods <span class="token operator">=</span> <span class="token function">findUsingReflection</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//从APT中收集的备选中查找</span>
        subscriberMethods <span class="token operator">=</span> <span class="token function">findUsingInfo</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriberMethods<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//订阅者类中至少有一个订阅者方法，否则运行时报错</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span><span class="token string">"Subscriber "</span> <span class="token operator">+</span> subscriberClass
                <span class="token operator">+</span> <span class="token string">" and its super classes have no public methods with the @Subscribe annotation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//找到后缓存到内存</span>
        METHOD_CACHE<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">,</span> subscriberMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> subscriberMethods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>运行时反射查找</strong> </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> <span class="token function">findUsingReflection</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//准备一个 FindState 实例，如果对象池中没有就new,一个FindState对应一个订阅者类，用于表示查找状态</span>
    FindState findState <span class="token operator">=</span> <span class="token function">prepareFindState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//存入订阅者 class</span>
    findState<span class="token punctuation">.</span><span class="token function">initForSubscriber</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//遍历subscriberClass的超类体系，调用findUsingReflectionInSingleClass查找当前clazz的所有订阅函数</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//在订阅者类中通过反射的方式查找订阅者方法</span>
        <span class="token function">findUsingReflectionInSingleClass</span><span class="token punctuation">(</span>findState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        findState<span class="token punctuation">.</span><span class="token function">moveToSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//获取父类继续查找</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//循环结束 findState.subscriberMethods 中保存了这个类中的所有订阅者方法</span>
    <span class="token keyword">return</span> <span class="token function">getMethodsAndRelease</span><span class="token punctuation">(</span>findState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<p>在订阅者类中通过反射的方式查找订阅者方法</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">findUsingReflectionInSingleClass</span><span class="token punctuation">(</span>FindState findState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//getDeclaredMethods 在某些设备上也会出现 NoClassDefFoundError</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//getDeclaredMethods 要比 getMethods 快，尤其是当订阅者是像 Activities 这样的胖类时</span>
        methods <span class="token operator">=</span> findState<span class="token punctuation">.</span>clazz<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> th<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//getMethods 在某些设备上也会出现 NoClassDefFoundError，可能会在 getMethods 周围添加 catch</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            methods <span class="token operator">=</span> findState<span class="token punctuation">.</span>clazz<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">LinkageError</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// super class of NoClassDefFoundError to be a bit more broad...</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//clazz.getDeclaredMethods()只返回当前clazz中声明的函数，</span>
        <span class="token comment" spellcheck="true">// 而clazz.getMethods()将返回clazz的所有函数(包括继承自父类和接口的函数)，</span>
        <span class="token comment" spellcheck="true">// 因此，此时skipSuperClasses被置为true，阻止递归查找父类。</span>
        findState<span class="token punctuation">.</span>skipSuperClasses <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//遍历所有方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Method method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> modifiers <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//修饰符</span>
        <span class="token comment" spellcheck="true">//MODIFIERS_IGNORE = Modifier.ABSTRACT | Modifier.STATIC | BRIDGE | SYNTHETIC;</span>
        <span class="token comment" spellcheck="true">//校验订阅者方法：must be public, non-static, and non-abstract"</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>modifiers <span class="token operator">&amp;</span> Modifier<span class="token punctuation">.</span>PUBLIC<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>modifiers <span class="token operator">&amp;</span> MODIFIERS_IGNORE<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> parameterTypes <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//参数类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parameterTypes<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//正好一个参数</span>
                Subscribe subscribeAnnotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>Subscribe<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribeAnnotation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 恰好一个参数的非静态的公开类并且有Subscribe注解标记</span>
                    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType <span class="token operator">=</span> parameterTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 参数为事件类</span>
                    <span class="token comment" spellcheck="true">//检查重名方法（本类或父类之间可能重复）用于控制findState.subscriberMethods是否添加找到的method</span>
                    <span class="token comment" spellcheck="true">//如果不校验，如果子类重写订阅者方法会导致执行两次子类的订阅者方法</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span><span class="token function">checkAdd</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ThreadMode threadMode <span class="token operator">=</span> subscribeAnnotation<span class="token punctuation">.</span><span class="token function">threadMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">//收集订阅者方法，封装 SubscriberMethod</span>
                        findState<span class="token punctuation">.</span>subscriberMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SubscriberMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> eventType<span class="token punctuation">,</span> threadMode<span class="token punctuation">,</span>
                                subscribeAnnotation<span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subscribeAnnotation<span class="token punctuation">.</span><span class="token function">sticky</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>strictMethodVerification <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span>Subscribe<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span><span class="token string">"@Subscribe method "</span> <span class="token operator">+</span> methodName <span class="token operator">+</span>
                        <span class="token string">"must have exactly 1 parameter but has "</span> <span class="token operator">+</span> parameterTypes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>strictMethodVerification <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span>Subscribe<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String methodName <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"."</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span>methodName <span class="token operator">+</span>
                    <span class="token string">" is a illegal @Subscribe method: must be public, non-static, and non-abstract"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>为啥不直接用Class.getMethods直接获取该类的全部方法呢？</p>
<p>如果这个类比较庞大，用getMethods查找所有的方法就显得很笨重了，<br>如果使用的是getDeclaredMethods（该类声明的方法不包括从父类那里继承来的public方法），速度就会快一些，因为找的方法变少了，没有什么 equals,toString,hashCode等Object类的方法。</p>
<p>Class#getMethods()，不检查方法签名（对于诸如不存在的参数类型之类的东西）。这已更改为 use Class#getDeclaredMethods()，它会检查并在出现问题时抛出异常。</p>
<p>FindState 对象和对象池</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> POOL_SIZE <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FindState<span class="token punctuation">[</span><span class="token punctuation">]</span> FIND_STATE_POOL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FindState</span><span class="token punctuation">[</span>POOL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> <span class="token function">getMethodsAndRelease</span><span class="token punctuation">(</span>FindState findState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> subscriberMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>findState<span class="token punctuation">.</span>subscriberMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
    findState<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//findState 回收数据</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>FIND_STATE_POOL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> POOL_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>FIND_STATE_POOL<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//将当前用过的 findState 缓存回去，下次注册时不用 new</span>
                FIND_STATE_POOL<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> findState<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> subscriberMethods<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//先从对象池中随便找一个，没有才创建</span>
<span class="token keyword">private</span> FindState <span class="token function">prepareFindState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//用的时候隔离开，用完了放回去。</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>FIND_STATE_POOL<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//FindState[] FIND_STATE_POOL</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> POOL_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//POOL_SIZE = 4</span>
            FindState state <span class="token operator">=</span> FIND_STATE_POOL<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                FIND_STATE_POOL<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//在原来的位置用null占位</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历FindState对象池，只要找到一个空对象就返回，</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FindState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FindState</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> subscriberMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token punctuation">,</span> Object<span class="token operator">></span> anyMethodByEventType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Class<span class="token operator">></span> subscriberClassByMethodKey <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> StringBuilder methodKeyBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">;</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz<span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> skipSuperClasses<span class="token punctuation">;</span>
    SubscriberInfo subscriberInfo<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">initForSubscriber</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subscriberClass <span class="token operator">=</span> clazz <span class="token operator">=</span> subscriberClass<span class="token punctuation">;</span>
        skipSuperClasses <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        subscriberInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscriberMethods<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        anyMethodByEventType<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscriberClassByMethodKey<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodKeyBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscriberClass <span class="token operator">=</span> null<span class="token punctuation">;</span>
        clazz <span class="token operator">=</span> null<span class="token punctuation">;</span>
        skipSuperClasses <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        subscriberInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 检查是否已经添加过这个订阅者方法</span>
    <span class="token keyword">boolean</span> <span class="token function">checkAdd</span><span class="token punctuation">(</span>Method method<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//2 级检查：仅具有事件类型的第一级（快速），在需要时具有完整签名的第二级。</span>
        <span class="token comment" spellcheck="true">// 通常订阅者没有侦听相同事件类型的方法。</span>
        <span class="token comment" spellcheck="true">//第一层判断有无method监听此eventType,如果没有则可直接把找到的method加到subscriberMethods中。</span>
        <span class="token comment" spellcheck="true">//第二层检查的是从MethodSignature（方法签名）判断能否把找到的method加进去。是为了防止在找父类时覆盖了子类的方法，因为此方法是子类是重写，方法名参数名完全一样（方法签名）；另一个原因是可能是当一个类有多个方法监听同一个event(尽管一般不会这样做)，也能将这些方法加进去。</span>
        Object existing <span class="token operator">=</span> anyMethodByEventType<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//没有添加过，</span>
            <span class="token comment" spellcheck="true">//anyMethodByEventType存储&lt;eventType, method>映射关系，</span>
            <span class="token comment" spellcheck="true">// 若existing为空，则表示eventType第一次出现。</span>
            <span class="token comment" spellcheck="true">// 一般情况下，一个对象只会有一个订阅函数处理特定eventType。</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><span class="token comment" spellcheck="true">//一个类有多个方法监听同一个事件类型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>existing <span class="token keyword">instanceof</span> <span class="token class-name">Method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//处理一个对象有多个订阅函数处理eventType的情况，</span>
                <span class="token comment" spellcheck="true">// 此时，anyMethodByEventType中eventType被映射到一个非Method对象(即this)。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAddWithMethodSignature</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Method<span class="token punctuation">)</span> existing<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Paranoia check</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Put any non-Method object to "consume" the existing Method</span>
                <span class="token comment" spellcheck="true">//将任何非 Method 对象“使用”现有的 Method</span>
                anyMethodByEventType<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">checkAddWithMethodSignature</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//由于存在多个订阅函数处理eventType，此时，单纯使用eventType作为key已经无法满足要求了，</span>
    <span class="token comment" spellcheck="true">// 因此，使用method.getName() + ">" + eventType.getName()作为methodKey，</span>
    <span class="token comment" spellcheck="true">// 并使用subscriberClassByMethodKey存储&lt;methodKey, methodClass>的映射关系。</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkAddWithMethodSignature</span><span class="token punctuation">(</span>Method method<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        methodKeyBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodKeyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        methodKeyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>eventType<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//onEvent>TestEvent</span>
        String methodKey <span class="token operator">=</span> methodKeyBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//getDeclaringClass: 返回表示类或接口的 Class 对象，该类或接口声明了由此对象表示的可执行文件。</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> methodClass <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//map["onEvent>TestEvent"]=</span>
        <span class="token comment" spellcheck="true">//如果methodClassOld或者methodClass是methodClassOld的子类，</span>
        <span class="token comment" spellcheck="true">// 则将&lt;methodKey, methodClass>放入，否则不放入。</span>
        <span class="token comment" spellcheck="true">// 满足函数名相同、参数类型相同且被@Subscribe修饰的函数，</span>
        <span class="token comment" spellcheck="true">// 在一个类中不可能存在两个；考虑类继承体系，若这样的两个函数分别来自父类和子类，</span>
        <span class="token comment" spellcheck="true">// 则最终被加入的是子类的函数。</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> methodClassOld <span class="token operator">=</span> subscriberClassByMethodKey<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>methodKey<span class="token punctuation">,</span> methodClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//确定此Class对象表示的类或接口是否与指定的Class参数表示的类或接口相同，或者是其超类或超接口。</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodClassOld <span class="token operator">==</span> null <span class="token operator">||</span> methodClassOld<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>methodClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Only add if not already found in a sub class</span>
            <span class="token comment" spellcheck="true">//仅在子类中未找到时才添加</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Revert the put, old class is further down the class hierarchy</span>
            <span class="token comment" spellcheck="true">//还原放置，旧类在类层次结构中更靠后</span>
            subscriberClassByMethodKey<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>methodKey<span class="token punctuation">,</span> methodClassOld<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">moveToSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>skipSuperClasses<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//反射方法时是通过getMethod 方式，已经包含父类方法了</span>
            clazz <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            clazz <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String clazzName <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Skip system classes, this degrades performance.</span>
            <span class="token comment" spellcheck="true">// Also we might avoid some ClassNotFoundException (see FAQ for background).</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazzName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"java."</span><span class="token punctuation">)</span> <span class="token operator">||</span> clazzName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"javax."</span><span class="token punctuation">)</span> <span class="token operator">||</span>
                    clazzName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"android."</span><span class="token punctuation">)</span> <span class="token operator">||</span> clazzName<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"androidx."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                clazz <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>通过APT中收集数据中查找</strong></p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> <span class="token function">findUsingInfo</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    FindState findState <span class="token operator">=</span> <span class="token function">prepareFindState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    findState<span class="token punctuation">.</span><span class="token function">initForSubscriber</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span>clazz <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//通过订阅者类从索引类中查找订阅者方法信息:subscriberInfo</span>
        findState<span class="token punctuation">.</span>subscriberInfo <span class="token operator">=</span> <span class="token function">getSubscriberInfo</span><span class="token punctuation">(</span>findState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span>subscriberInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SubscriberMethod<span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> findState<span class="token punctuation">.</span>subscriberInfo<span class="token punctuation">.</span><span class="token function">getSubscriberMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>SubscriberMethod subscriberMethod <span class="token operator">:</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 检查重名方法（本类或父类之间都可能重复</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span><span class="token function">checkAdd</span><span class="token punctuation">(</span>subscriberMethod<span class="token punctuation">.</span>method<span class="token punctuation">,</span> subscriberMethod<span class="token punctuation">.</span>eventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    findState<span class="token punctuation">.</span>subscriberMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>subscriberMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//apt 没有正常收集该类，降级为反射方式查找</span>
            <span class="token function">findUsingReflectionInSingleClass</span><span class="token punctuation">(</span>findState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        findState<span class="token punctuation">.</span><span class="token function">moveToSuperclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">getMethodsAndRelease</span><span class="token punctuation">(</span>findState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> SubscriberInfo <span class="token function">getSubscriberInfo</span><span class="token punctuation">(</span>FindState findState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//找完子类找父类</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span>subscriberInfo <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> findState<span class="token punctuation">.</span>subscriberInfo<span class="token punctuation">.</span><span class="token function">getSuperSubscriberInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SubscriberInfo superclassInfo <span class="token operator">=</span> findState<span class="token punctuation">.</span>subscriberInfo<span class="token punctuation">.</span><span class="token function">getSuperSubscriberInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>findState<span class="token punctuation">.</span>clazz <span class="token operator">==</span> superclassInfo<span class="token punctuation">.</span><span class="token function">getSubscriberClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> superclassInfo<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//apt 收集的索引类</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriberInfoIndexes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//通过订阅者类从索引类中查找订阅者方法信息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SubscriberInfoIndex index <span class="token operator">:</span> subscriberInfoIndexes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SubscriberInfo info <span class="token operator">=</span> index<span class="token punctuation">.</span><span class="token function">getSubscriberInfo</span><span class="token punctuation">(</span>findState<span class="token punctuation">.</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> info<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>查找流程小结</strong></p>
<p>注册订阅者分为查找和订阅两个过程</p>
<p>查找过程具体是通过当前订阅者类找出该类中声明的所有订阅者方法。查找逻辑封装在 SubscriberMethodFinder 类中，查找方式有两中，如果使用了注解处理器模块就可以通过生成的索引类查找，这种方式不需要通过反射就能收集到所有订阅者方法，效率较高。</p>
<p>还有一种就是运行时通过反射订阅者类的getMethods 或者getDeclaredMethods这两个方法收集订阅者方法，这种方式效率低，不推荐使用。</p>
<p>亮点整理：</p>
<ul>
<li>METHOD_CACHE 缓存了查找过的进程内所有订阅者的键值对(订阅者类，类中的订阅者方法)信息，使用ConcurrentHashMap即保证的查找效率也避免了线程安全问题。</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">>></span> METHOD_CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>FIND_STATE_POOL 是 FindState 对象池的一维静态数组，FindState 对查找的状态值做了一些封装以及对订阅者方法的检查逻辑。<ul>
<li>为什么要使用FindState呢？首先是面向对象封装的采用</li>
<li>在JVM系统中频繁地创建对象，是非常消耗资源的，在jvm垃圾回收时候，有可能会出现内存抖动的问题。使用对象池数组就有效的避免了内存抖动的问题。</li>
<li>对 FIND_STATE_POOL  的操作需要考虑线程同步问题，这里使用了<code>synchronized</code>关键字来保证线程安全。</li>
</ul>
</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> FindState<span class="token punctuation">[</span><span class="token punctuation">]</span> FIND_STATE_POOL <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FindState</span><span class="token punctuation">[</span>POOL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre>
<p><strong>订阅流程</strong></p>
<p>查找到当前注册的订阅者类中的所有订阅者方法后，下一步就是为每一个订阅者方法执行订阅流程了。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>Object subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> subscriberClass <span class="token operator">=</span> subscriber<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 01查找订阅者方法流程</span>
    <span class="token comment" spellcheck="true">// 通过订阅者类找出该类中所有的订阅者方法</span>
    List<span class="token operator">&lt;</span>SubscriberMethod<span class="token operator">></span> subscriberMethods <span class="token operator">=</span> subscriberMethodFinder<span class="token punctuation">.</span><span class="token function">findSubscriberMethods</span><span class="token punctuation">(</span>subscriberClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//遍历该订阅者类中所有订阅者方法，执行订阅操作</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>SubscriberMethod subscriberMethod <span class="token operator">:</span> subscriberMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 02订阅流程</span>
            <span class="token comment" spellcheck="true">// 收集订阅者，事件类，分发粘性事件等</span>
            <span class="token function">subscribe</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">,</span> subscriberMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>订阅流程大题分为三步</p>
<ul>
<li>通过事件类找所有已经订阅过该事件的订阅者们，目的是为了进行优先级排序,全局缓存已注册订阅者等</li>
<li>通过订阅者类找所有已经注册过的 Event 们， 用于判断是否注册、解注册等</li>
<li>当前订阅者中有粘性事件，在 register 的时候根据当前订阅者方法的 event 直接执行分发</li>
</ul>
<pre class=" language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">subscribe</span><span class="token punctuation">(</span>Object subscriber<span class="token punctuation">,</span> SubscriberMethod subscriberMethod<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//事件类</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType <span class="token operator">=</span> subscriberMethod<span class="token punctuation">.</span>eventType<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//封装订阅者</span>
    Subscription newSubscription <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subscription</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">,</span> subscriberMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//Map&lt;Class&lt;?>, CopyOnWriteArrayList&lt;Subscription>> subscriptionsByEventType;</span>
    <span class="token comment" spellcheck="true">//通过事件类找所有该事件的订阅者，</span>
    CopyOnWriteArrayList<span class="token operator">&lt;</span>Subscription<span class="token operator">></span> subscriptions <span class="token operator">=</span> subscriptionsByEventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//还没缓存该事件就存且只能存一次</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscriptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subscriptionsByEventType<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> subscriptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//不能有重复订阅者</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>newSubscription<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span><span class="token string">"Subscriber "</span> <span class="token operator">+</span> subscriber<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" already registered to event "</span>
                    <span class="token operator">+</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> size <span class="token operator">=</span> subscriptions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//优先级排序，要么最小查到最后，要么之前的某个位置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> size <span class="token operator">||</span> subscriberMethod<span class="token punctuation">.</span>priority <span class="token operator">></span> subscriptions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>subscriberMethod<span class="token punctuation">.</span>priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//向事件对应的订阅者列表中添加当前订阅者，完成排序操作</span>
            subscriptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> newSubscription<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//Map&lt;Object, List&lt;Class&lt;?>>> typesBySubscriber;</span>
    <span class="token comment" spellcheck="true">//通过订阅者类找所有Event</span>
    List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> subscribedEvents <span class="token operator">=</span> typesBySubscriber<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribedEvents <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subscribedEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        typesBySubscriber<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">,</span> subscribedEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//将当前订阅者方法的 event 存到指定订阅者类下的列表里</span>
    subscribedEvents<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//粘性事件：先pst 后 订阅</span>
    <span class="token comment" spellcheck="true">//当前订阅者中有粘性事件，在 register 的时候根据当前订阅者方法的 event 直接执行分发</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriberMethod<span class="token punctuation">.</span>sticky<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//eventInheritance: 默认true</span>
        <span class="token comment" spellcheck="true">// 默认情况下，EventBus 考虑事件类层次结构（将通知超类的订阅者）。 关闭此功能将改进事件的发布。</span>
        <span class="token comment" spellcheck="true">// 对于直接扩展 Object 的简单事件类，我们测得事件发布速度提高了 20%。 对于更复杂的事件层次结构，加速应该大于 20%。</span>
        <span class="token comment" spellcheck="true">//但是，请记住，事件发布通常只消耗应用程序内一小部分 CPU 时间，除非它以高速率发布，例如每秒数百/数千个事件</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventInheritance<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//</span>
            <span class="token comment" spellcheck="true">//必须考虑 eventType 的所有子类的现有粘性事件。注意：对于大量粘性事件，迭代所有事件可能效率低下，</span>
            <span class="token comment" spellcheck="true">// 因此应更改数据结构以允许更有效的查找（例如，存储超类的子类的附加映射：Class -> List&lt;Class>）。</span>
            <span class="token comment" spellcheck="true">//stickyEvents = new ConcurrentHashMap&lt;>();</span>
            Set<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Object<span class="token operator">>></span> entries <span class="token operator">=</span> stickyEvents<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> Object<span class="token operator">></span> entry <span class="token operator">:</span> entries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//key: event.getClass(), value: event</span>
                Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> candidateEventType <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//isAssignableFrom: 确定此Class对象表示的类或接口是否与指定的Class参数表示的类或接口相同，或者是其超类或超接口。 如果是，则返回true ； 否则返回false 。 如果此Class对象表示原始类型，则如果指定的Class参数正是此Class对象，则此方法返回true ； 否则返回false 。</span>
                <span class="token comment" spellcheck="true">//具体来说，此方法测试是否可以通过标识转换或通过扩展引用转换将指定Class参数表示的类型转换为此Class对象表示的类型。 有关详细信息，请参阅Java 语言规范5.1.1 和 5.1.4 节</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>candidateEventType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//比较class</span>
                    Object stickyEvent <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">checkPostStickyEventToSubscription</span><span class="token punctuation">(</span>newSubscription<span class="token punctuation">,</span> stickyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//通过粘性事件类查找所有粘性事件对象</span>
            Object stickyEvent <span class="token operator">=</span> stickyEvents<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkPostStickyEventToSubscription</span><span class="token punctuation">(</span>newSubscription<span class="token punctuation">,</span> stickyEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkPostStickyEventToSubscription</span><span class="token punctuation">(</span>Subscription newSubscription<span class="token punctuation">,</span> Object stickyEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stickyEvent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// If the subscriber is trying to abort the event, it will fail (event is not tracked in posting state)</span>
        <span class="token comment" spellcheck="true">// --> Strange corner case, which we don't take care of here.</span>
        <span class="token comment" spellcheck="true">//如果订阅者试图中止事件，它将失败（事件在发布状态下不被跟踪）--> 奇怪的极端情况，我们在这里不处理。</span>
        <span class="token function">postToSubscription</span><span class="token punctuation">(</span>newSubscription<span class="token punctuation">,</span> stickyEvent<span class="token punctuation">,</span> <span class="token function">isMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="注册订阅者流程总结"><a href="#注册订阅者流程总结" class="headerlink" title="注册订阅者流程总结"></a>注册订阅者流程总结</h5><p>注册订阅者分为查找和订阅两个过程</p>
<p>查找过程具体是通过当前订阅者类找出该类中声明的所有订阅者方法。查找逻辑封装在 SubscriberMethodFinder 类中，查找方式有两中，如果使用了注解处理器模块就可以通过生成的索引类查找，这种方式不需要通过反射就能收集到所有订阅者方法，效率较高。</p>
<p>还有一种就是运行时通过反射订阅者类的getMethods 或者getDeclaredMethods这两个方法收集订阅者方法，这种方式效率低，不推荐使用。</p>
<p>订阅过程具体是针对当前订阅者的每一个订阅者方法（查找流程得到）以事件类为范围进行全局排序，收集当前订阅者类的所有事件以及对粘性事件的分发。</p>
<p>亮点整理：</p>
<ul>
<li>CopyOnWriteArrayList 保证线程安全</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">,</span> CopyOnWriteArrayList<span class="token operator">&lt;</span>Subscription<span class="token operator">>></span> subscriptionsByEventType<span class="token punctuation">;</span></code></pre>
<ul>
<li>ConcurrentHashMap 保证了效率和安全</li>
</ul>
<pre class=" language-java"><code class="language-java">stickyEvents <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="10-2-3-事件发布"><a href="#10-2-3-事件发布" class="headerlink" title="10.2.3 事件发布"></a>10.2.3 事件发布</h4><p>发布粘性事件，粘性事件特别之处在于发布前存到了一个map中，当注册时直接执行粘性事件的发布</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postSticky</span><span class="token punctuation">(</span>Object event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>stickyEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stickyEvents<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">//放置后应发布，以防订阅者想立即删除</span>
    <span class="token function">post</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>发布普通事件，通过ThreadLocal保证发送时的同步问题</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">post</span><span class="token punctuation">(</span>Object event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//currentPostingThreadState = new ThreadLocal&lt;PostingThreadState>()</span>
    <span class="token comment" spellcheck="true">//每个线程都有一份 postingState 实例，</span>
    <span class="token comment" spellcheck="true">//封装 PostingThreadState 对于 ThreadLocal，设置（并获得多个值）要快得多。</span>
    PostingThreadState postingState <span class="token operator">=</span> currentPostingThreadState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    List<span class="token operator">&lt;</span>Object<span class="token operator">></span> eventQueue <span class="token operator">=</span> postingState<span class="token punctuation">.</span>eventQueue<span class="token punctuation">;</span>
    eventQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>postingState<span class="token punctuation">.</span>isPosting<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 默认 false</span>
        postingState<span class="token punctuation">.</span>isMainThread <span class="token operator">=</span> <span class="token function">isMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//判断主线程还是子线程</span>
        postingState<span class="token punctuation">.</span>isPosting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//这里保证 cancelEventDelivery 是在同一个线程调用的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>postingState<span class="token punctuation">.</span>canceled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//cancelEventDelivery</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EventBusException</span><span class="token punctuation">(</span><span class="token string">"Internal error. Abort state was not reset"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//可能发送了多个事件</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>eventQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//发送队列依次取出第一个事件执行发布</span>
                <span class="token function">postSingleEvent</span><span class="token punctuation">(</span>eventQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> postingState<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//发送完事件后重置标志位</span>
            postingState<span class="token punctuation">.</span>isPosting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            postingState<span class="token punctuation">.</span>isMainThread <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>事件发布时考虑事件的继承关系</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//发送队列的第一个事件</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postSingleEvent</span><span class="token punctuation">(</span>Object event<span class="token punctuation">,</span> PostingThreadState postingState<span class="token punctuation">)</span> <span class="token keyword">throws</span> Error <span class="token punctuation">{</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventClass <span class="token operator">=</span> event<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> subscriptionFound <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//是否考虑订阅者的继承关系</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eventInheritance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//事件类和事件类的父类们</span>
        List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> eventTypes <span class="token operator">=</span> <span class="token function">lookupAllEventTypes</span><span class="token punctuation">(</span>eventClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> countTypes <span class="token operator">=</span> eventTypes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> h <span class="token operator">&lt;</span> countTypes<span class="token punctuation">;</span> h<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> eventTypes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//当前类和父类有一个没收到就算失败</span>
            subscriptionFound <span class="token operator">|=</span> <span class="token function">postSingleEventForEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> postingState<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        subscriptionFound <span class="token operator">=</span> <span class="token function">postSingleEventForEventType</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> postingState<span class="token punctuation">,</span> eventClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriptionFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logNoSubscriberMessages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Level<span class="token punctuation">.</span>FINE<span class="token punctuation">,</span> <span class="token string">"No subscribers registered for event "</span> <span class="token operator">+</span> eventClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//兜底方案，发送一个通知事件，告诉订阅者刚才的事件没发送成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendNoSubscriberEvent <span class="token operator">&amp;&amp;</span> eventClass <span class="token operator">!=</span> NoSubscriberEvent<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span>
                eventClass <span class="token operator">!=</span> SubscriberExceptionEvent<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NoSubscriberEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>通过单事件，找到所有观察者，遍历所有观察该事件的观察者，执行发布操作</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">postSingleEventForEventType</span><span class="token punctuation">(</span>Object event<span class="token punctuation">,</span> PostingThreadState postingState<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    CopyOnWriteArrayList<span class="token operator">&lt;</span>Subscription<span class="token operator">></span> subscriptions<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//通过单事件，找到所有观察者</span>
        subscriptions <span class="token operator">=</span> subscriptionsByEventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>subscriptions<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Subscription subscription <span class="token operator">:</span> subscriptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//存入线程</span>
            postingState<span class="token punctuation">.</span>event <span class="token operator">=</span> event<span class="token punctuation">;</span>
            postingState<span class="token punctuation">.</span>subscription <span class="token operator">=</span> subscription<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> aborted<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">postToSubscription</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">,</span> postingState<span class="token punctuation">.</span>isMainThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
                aborted <span class="token operator">=</span> postingState<span class="token punctuation">.</span>canceled<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//重置状态</span>
                postingState<span class="token punctuation">.</span>event <span class="token operator">=</span> null<span class="token punctuation">;</span>
                postingState<span class="token punctuation">.</span>subscription <span class="token operator">=</span> null<span class="token punctuation">;</span>
                postingState<span class="token punctuation">.</span>canceled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>发布时会根据订阅者的线程模型做出不同处理</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//发布到订阅</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postToSubscription</span><span class="token punctuation">(</span>Subscription subscription<span class="token punctuation">,</span> Object event<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//根据线程模型不同处理</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>subscriberMethod<span class="token punctuation">.</span>threadMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> POSTING<span class="token operator">:</span> <span class="token comment" spellcheck="true">//订阅和发布是同一个线程</span>
            <span class="token function">invokeSubscriber</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MAIN<span class="token operator">:</span> <span class="token comment" spellcheck="true">//订阅在主线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">invokeSubscriber</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//通过Handler 发送到主线程</span>
                mainThreadPoster<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MAIN_ORDERED<span class="token operator">:</span> <span class="token comment" spellcheck="true">//订阅在主线程排队</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mainThreadPoster <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mainThreadPoster<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//临时：技术上不正确，因为海报没有与订阅者分离</span>
                <span class="token comment" spellcheck="true">// temporary: technically not correct as poster not decoupled from subscriber</span>
                <span class="token function">invokeSubscriber</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> BACKGROUND<span class="token operator">:</span><span class="token operator">/</span><span class="token comment" spellcheck="true">///如果发帖线程非主线程则订阅者的处理会在工作线程中执行否则和发布者同一个线程处理。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isMainThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                backgroundPoster<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">invokeSubscriber</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ASYNC<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>无论事件在哪个线程发布，订阅者都会在新建的工作线程中执行。
            asyncPoster<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unknown thread mode: "</span> <span class="token operator">+</span> subscription<span class="token punctuation">.</span>subscriberMethod<span class="token punctuation">.</span>threadMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>三个发布器 mainThreadPoster,backgroundPoster,asyncPoster  对应四种线程模型</p>
<p>反射调用观察者</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//同一个线程执行订阅者方法</span>
<span class="token keyword">void</span> <span class="token function">invokeSubscriber</span><span class="token punctuation">(</span>Subscription subscription<span class="token punctuation">,</span> Object event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//方法、类、参数</span>
        subscription<span class="token punctuation">.</span>subscriberMethod<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>subscriber<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">handleSubscriberException</span><span class="token punctuation">(</span>subscription<span class="token punctuation">,</span> event<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="事件发布流程总结"><a href="#事件发布流程总结" class="headerlink" title="事件发布流程总结"></a>事件发布流程总结</h5><p>发布事件通过ThreadLocal保证发送时的同步问题，粘性事件就是发布前存到一个map中，当订阅者注册时会遍历该map执行粘性事件的发布，事件发布时默认会考虑事件的继承关系即订阅事件的父类的订阅者也会收到事件。</p>
<p>具体发布过程为：通过单事件，找到所有观察者，遍历所有观察该事件的观察者，执行发布操作，发布时会根据订阅者的线程模型做出不同处理，通过三个发布器 mainThreadPoster,backgroundPoster,asyncPoster  完成四种线程模型的切换，最后通过反射调用观察者。</p>
<h4 id="10-2-4-注销订阅者"><a href="#10-2-4-注销订阅者" class="headerlink" title="10.2.4 注销订阅者"></a>10.2.4 注销订阅者</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> override fun <span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unregister</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>根据订阅者类找该类的所有事件</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">unregister</span><span class="token punctuation">(</span>Object subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//找到订阅者类对应的事件类列表</span>
    List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> subscribedTypes <span class="token operator">=</span> typesBySubscriber<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribedTypes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//根据每个事件类解除每个订阅者</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType <span class="token operator">:</span> subscribedTypes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">unsubscribeByEventType</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//从内存map 移除</span>
        typesBySubscriber<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>subscriber<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>Level<span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"Subscriber to unregister was not registered before: "</span> <span class="token operator">+</span> subscriber<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>根据每个事件找对应的所有订阅者，如果订阅者中的订阅者类和当前类一样才执行解除订阅</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unsubscribeByEventType</span><span class="token punctuation">(</span>Object subscriber<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//根据每个事件类找到所有该事件的订阅者</span>
    List<span class="token operator">&lt;</span>Subscription<span class="token operator">></span> subscriptions <span class="token operator">=</span> subscriptionsByEventType<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptions <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> subscriptions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//每个订阅者：类+方法</span>
            Subscription subscription <span class="token operator">=</span> subscriptions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//确认是当前类的订阅者</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subscription<span class="token punctuation">.</span>subscriber <span class="token operator">==</span> subscriber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//修改解除订阅标志位</span>
                subscription<span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                subscriptions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                i<span class="token operator">--</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//防止越界</span>
                size<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h5 id="注销订阅者流程总结"><a href="#注销订阅者流程总结" class="headerlink" title="注销订阅者流程总结"></a>注销订阅者流程总结</h5><p>注销流程就是先通过订阅者类找所有事件，遍历每一个事件找所有订阅者，判断订阅者中的订阅者类是否和当前类一致，一致就将订阅者中的 active 标记为false 用来阻止继续发布事件，并从内存map中移除。</p>
<h2 id="11-参考"><a href="#11-参考" class="headerlink" title="11. 参考"></a>11. 参考</h2><p><strong><a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">Github | EventBus</a></strong></p>
<p><a href="https://greenrobot.org/eventbus/documentation/" target="_blank" rel="noopener">EventBus Documentation</a></p>
<p><a href="https://time.geekbang.org/column/intro/250?code=Grxvvkczx9tydhzn0RhJfNfwaF2RgJA9qeUWd8orIYo%3D" target="_blank" rel="noopener">极客时间| 设计模式之美</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1383971" target="_blank" rel="noopener">EventBus 如何使用及一些常见场景</a></p>
<p><a href="https://blog.csdn.net/f552126367/article/details/86571012" target="_blank" rel="noopener">EventBus使用总结和使用场景</a></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Jay</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.basedev.cn/2021/01/31/lib-eventbus/">http://www.basedev.cn/2021/01/31/lib-eventbus/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Jay</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F/">
                                    <span class="chip bg-color">观察者模式</span>
                                </a>
                            
                                <a href="/tags/EventBus/">
                                    <span class="chip bg-color">EventBus</span>
                                </a>
                            
                                <a href="/tags/%E4%BA%8B%E4%BB%B6%E6%80%BB%E7%BA%BF/">
                                    <span class="chip bg-color">事件总线</span>
                                </a>
                            
                                <a href="/tags/%E6%A1%86%E6%9E%B6/">
                                    <span class="chip bg-color">框架</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat,qq,qzone,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Sun Jan 31 2021 14:16:55 GMT+0800',
    owner: 'jaydroid1024',
    repo: 'hexo_blog_repo',
    oauth: {
        client_id: '4c4d58f27f5177dff57c',
        client_secret: 'c9fce45c9250437cb34e3a7755c4135df47aa65b'
    }
});

gitment.render('gitment-content');
</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/05/21/jetpack-lifecycle/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Jetpack | Lifecycle 组件系详解第一篇：Lifecycle">
                        
                        <span class="card-title">Jetpack | Lifecycle 组件系详解第一篇：Lifecycle</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Lifecycle 是什么，有什么，怎么用，应用场景，实现原理等
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-05-21
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Jetpack/" class="post-category">
                                    Jetpack
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Jetpack/">
                        <span class="chip bg-color">Jetpack</span>
                    </a>
                    
                    <a href="/tags/Lifecycle/">
                        <span class="chip bg-color">Lifecycle</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/07/31/java-jvm/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="筑基系列-JVM基础知识小抄版">
                        
                        <span class="card-title">筑基系列-JVM基础知识小抄版</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            JVM 内存结构/HotSpot 虚拟机对象探秘/垃圾收集策略与算法/HotSpot 垃圾收集器/内存分配与回收策略/JVM 性能调优/类文件结构/类加载的时机/类加载的过程/类加载器
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-07-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%A1%86%E6%9E%B6/" class="post-category">
                                    框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 王学杰<br />'
            + '文章作者: Jay<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2021</span>
            <a href="/about" target="_blank">Jay</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">110.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "1";
                    var startDate = "1";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
            <span id="icp"><img src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2020043565号-1</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/jaydroid1024" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wangxuejie@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1018673209" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1018673209" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?88efcea1b43fcd428172af2f7305f80e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
