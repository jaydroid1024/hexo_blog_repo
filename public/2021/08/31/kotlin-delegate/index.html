<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Kotlin | 委托(Delegation﻿)详解, 筑基、体系、实践、分享">
    <meta name="description" content="筑基、体系、实践、分享">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=G-N498NKZS3G"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-N498NKZS3G');
</script>


    <title>Kotlin | 委托(Delegation﻿)详解 | 王学杰</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 4.2.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="王学杰" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">王学杰</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>主页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">王学杰</div>
        <div class="logo-desc">
            
            筑基、体系、实践、分享
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			主页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/jaydroid1024" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/jaydroid1024" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/8.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Kotlin | 委托(Delegation﻿)详解</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ViewBinding/">
                                <span class="chip bg-color">ViewBinding</span>
                            </a>
                        
                            <a href="/tags/Kotlin-%E5%A7%94%E6%89%98/">
                                <span class="chip bg-color">Kotlin 委托</span>
                            </a>
                        
                            <a href="/tags/%E5%B1%9E%E6%80%A7%E5%A7%94%E6%89%98/">
                                <span class="chip bg-color">属性委托</span>
                            </a>
                        
                            <a href="/tags/ViewModel/">
                                <span class="chip bg-color">ViewModel</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Kotlin/" class="post-category">
                                Kotlin
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-08-31
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2021-09-19
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    9.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    42 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p><img src="https://raw.githubusercontent.com/jaydroid1024/jay_image_repo/main/img/post_banner_jay.png" alt=""></p>
<h1 id="Kotlin-委托-Delegation-详解"><a href="#Kotlin-委托-Delegation-详解" class="headerlink" title="Kotlin | 委托(Delegation﻿)详解"></a>Kotlin | 委托(Delegation﻿)详解</h1><p>本文要点概述</p>
<ul>
<li><p>辨析委托模式与代理模式 </p>
</li>
<li><p>接口委托(Delegated interface)</p>
</li>
<li><p>属性委托(Delegated properties)</p>
</li>
<li><p>映射委托(Map delegation)</p>
</li>
<li><p>延迟属性(lazy properties)</p>
</li>
<li><p>非空属性(Delegates.notNull)</p>
</li>
<li><p>变量值更新后的监听(Delegates.observable)</p>
</li>
<li><p>变量值更新前的拦截(Delegates.vetoable)</p>
</li>
<li><p>ViewBinding+属性委托</p>
</li>
<li><p>ViewModel+属性委托</p>
</li>
<li><p>SP +属性委托</p>
</li>
</ul>
<h2 id="1-委托模式-VS-代理模式"><a href="#1-委托模式-VS-代理模式" class="headerlink" title="1.委托模式 VS 代理模式"></a>1.委托模式 VS 代理模式</h2><p>委托模式和代理模式都属于结构型设计模式，结构型模式主要总结了一些类或对象组合在一起的经典结构，这些经典的结构可以解决特定应用场景的问题。</p>
<h3 id="1-1-代理模式（Proxy-Pattern）"><a href="#1-1-代理模式（Proxy-Pattern）" class="headerlink" title="1.1 代理模式（Proxy Pattern）"></a>1.1 代理模式（Proxy Pattern）</h3><p>在不改变原始类接口的条件下，为原始类定义一个代理类，主要目的是控制访问，而非加强功能，这是它跟装饰器模式最大的不同。在代理类中还可以提供额外的逻辑， 例如当真实对象上的操作是资源密集型任务时可以在代理中添加缓存操作，或者在调用真实对象操作之前做一些权限校验或检查行为等。一般情况下，我们让代理类和原始类实现同样的接口或者让代理类继承原始类来实现代理模式。</p>
<h3 id="1-2-委托模式（Delegation-pattern）"><a href="#1-2-委托模式（Delegation-pattern）" class="headerlink" title="1.2 委托模式（Delegation pattern）"></a>1.2 委托模式（Delegation pattern）</h3><p>委托可以理解为是代理的一种变体，是一种使组合像继承一样实现代码复用的另一种设计模式。主要目的是组合委托调用和代码复用而不考虑控制访问等逻辑。在委托中处理请求涉及两个对象，委托方将操作交给受托方实现，类似于子类将请求推迟到父类。一般情况下，委托也可以通过接口约束或受托方继承委托方实现委托模式。</p>
<h3 id="1-3-法律层面区分代理与委托"><a href="#1-3-法律层面区分代理与委托" class="headerlink" title="1.3 法律层面区分代理与委托"></a>1.3 法律层面区分代理与委托</h3><p>为了加深代理和委托的理解，我们看一下<strong>法律层面的代理与委托的不同之处</strong></p>
<ul>
<li><p>民事主体活动的名义不同。 代理是指被代理人在代理权限范围内，以被代理人的名义同第三人独立为民事法律行为，由此产生的法律效果直接归属于被代理人的一种法律制度，即代理人必须以被代理人的名义为代理行为。 委托则是委托人委托受托人处理一定事务，受托人接受委托的协议，受托人可以以委托人的名义活动，也可以以自己的名义活动。</p>
</li>
<li><p>适用范围不尽相同：代理只是代理人在代理权范围内以被代理人的名义同第三人的民事法律行为；而委托中的受托人办理委托人委托事务的行为可以是民事法律行为，还可以是有经济意义的行为（如整理账簿）和单纯的事实行为（如抄写文件）。</p>
</li>
<li><p>效力范围不同：代理涉及三方当事人，即被代理人、代理人、第三人；委托则属于双方当事人之间的关系，即委托人、受托人。</p>
</li>
</ul>
<h3 id="1-4-代码实现委托和代理"><a href="#1-4-代码实现委托和代理" class="headerlink" title="1.4 代码实现委托和代理"></a>1.4 代码实现委托和代理</h3><p>代理模式和委托模式在代码实现上并没有太多差别，他们的差异还是在使用场景上，为了能更好的理解代理模式和委托模式，我们再来看看如何通过代码来实现</p>
<p>代码参考自：<strong><a href="https://github.com/iluwatar/java-design-patterns" target="_blank" rel="noopener"> java-design-patterns</a></strong></p>
<p><a href="https://github.com/iluwatar/java-design-patterns/tree/master/delegation" target="_blank" rel="noopener">delegation</a> ：打印机控制器将打印任务委托给不同的打印机</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 委托二人组：打印机控制器、打印机（惠普打印机、佳能打印机、爱普生打印机）</span>
<span class="token comment" spellcheck="true">// 电脑上有三种打印机设备的驱动，分别将打印任务委托给对应的打印机执行具体的打印操作</span>
PrinterController hpPrinterController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrinterController</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HpPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PrinterController canonPrinterController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrinterController</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CanonPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PrinterController epsonPrinterController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrinterController</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EpsonPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hpPrinterController<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>MESSAGE_TO_PRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
canonPrinterController<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>MESSAGE_TO_PRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
epsonPrinterController<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>MESSAGE_TO_PRINT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//打印机控制器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PrinterController</span> <span class="token keyword">implements</span> <span class="token class-name">Printer</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> Printer printer<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">PrinterController</span><span class="token punctuation">(</span>Printer printer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>printer <span class="token operator">=</span> printer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">/** 
   * 此方法是从 {@link Printer} 实现的，在提供实现时它会调用通过构造函数传递的委托方的 print 方法。 
   * 这意味着委托关系一旦确定后，调用者不关心实现类，只关心拥有的打印机控制器就行。
   */</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>String message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    printer<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//三个打印机也实现了 Printer 接口 并提供了具体的打印功能，代码可以参考上面的链接</span></code></pre>
<p><a href="https://github.com/iluwatar/java-design-patterns/tree/master/proxy" target="_blank" rel="noopener">proxy</a> ：巫师要进入塔内修炼法术，象牙塔只能通过代理访问并确保只有前三个巫师可以进入。</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 代理三人组：巫师塔代理、象牙塔、巫师</span>
WizardTowerProxy proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WizardTowerProxy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IvoryTower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wizard</span><span class="token punctuation">(</span><span class="token string">"Red wizard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wizard</span><span class="token punctuation">(</span><span class="token string">"White wizard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wizard</span><span class="token punctuation">(</span><span class="token string">"Black wizard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wizard</span><span class="token punctuation">(</span><span class="token string">"Green wizard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
proxy<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Wizard</span><span class="token punctuation">(</span><span class="token string">"Brown wizard"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//代理方：塔代理</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WizardTowerProxy</span> <span class="token keyword">implements</span> <span class="token class-name">WizardTower</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NUM_WIZARDS_ALLOWED <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> WizardTower tower<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> numWizards<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">//被代理方通过构造方法传入</span>
  <span class="token keyword">public</span> <span class="token function">WizardTowerProxy</span><span class="token punctuation">(</span>WizardTower tower<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tower <span class="token operator">=</span> tower<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">//对象牙塔的访问的代理。第三方通过 enter 方法进入</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span>Wizard wizard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//超过三个就不让进了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>numWizards <span class="token operator">&lt;</span> NUM_WIZARDS_ALLOWED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">//代理方授权执行操作</span>
      tower<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span>wizard<span class="token punctuation">)</span><span class="token punctuation">;</span>
      numWizards<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"{} is not allowed to enter!"</span> <span class="token operator">+</span> wizard<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//被代理方：塔</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IvoryTower</span> <span class="token keyword">implements</span> <span class="token class-name">WizardTower</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span>Wizard wizard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"{} enters the tower."</span> <span class="token operator">+</span> wizard<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//第三方：巫师</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Wizard</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> String name<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token function">Wizard</span><span class="token punctuation">(</span>String wizard<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> wizard<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="2-接口委托-Delegated-interface"><a href="#2-接口委托-Delegated-interface" class="headerlink" title="2. 接口委托(Delegated interface)"></a>2. 接口委托(Delegated interface)</h2><p>我们看看Kotlin 是怎么内置接口委托的，先看一下实现的委托模式的传统方式</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> Api <span class="token punctuation">{</span>
    <span class="token keyword">fun</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//委托方</span>
<span class="token keyword">class</span> ApiImpl <span class="token operator">:</span> Api <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiImpl-a"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiImpl-b"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiImpl-c"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//受托方</span>
<span class="token keyword">class</span> <span class="token function">ApiWrapper</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> api<span class="token operator">:</span> Api<span class="token punctuation">)</span> <span class="token operator">:</span> Api <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiWrapper-a"</span><span class="token punctuation">)</span>
        api<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiWrapper-b"</span><span class="token punctuation">)</span>
        api<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiWrapper-c"</span><span class="token punctuation">)</span>
        api<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>再看看Kotlin 通过 <code>by</code> 关键字实现的简便方式</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//变量 api代替 ApiWrapperWithDelegate 实现了 Api 接口，ApiWrapperWithDelegate 就可以灵活的复写需要的函数</span>
<span class="token keyword">class</span> <span class="token function">ApiWrapperWithDelegate</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> api<span class="token operator">:</span> Api<span class="token punctuation">)</span> <span class="token operator">:</span> Api <span class="token keyword">by</span> api <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ApiWrapperWithDelegate-a"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">//反编译 Java 后的代码和 ApiWrapper 是一样的</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> ApiWrapperWithDelegate implements Api <span class="token punctuation">{</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> Api api<span class="token punctuation">;</span>
   <span class="token keyword">public</span> void <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      String var1 <span class="token operator">=</span> <span class="token string">"ApiWrapperWithDelegate-a"</span><span class="token punctuation">;</span>
      boolean var2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token function">ApiWrapperWithDelegate</span><span class="token punctuation">(</span><span class="token annotation builtin">@NotNull</span> Api api<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Intrinsics<span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> <span class="token string">"api"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>api <span class="token operator">=</span> api<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> void <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> void <span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>api<span class="token punctuation">.</span><span class="token function">c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看到 Kotlin 内置的接口委托是编译器帮我们生成了相关代码</p>
<p>再看一个实践的例子：利用接口代理实现一个集成了 map 和 list 的超级集合</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">// 对象 list 和 map 代理 SupperArrayWithDelegate 实现 MutableList，MutableMap</span>
<span class="token keyword">class</span> SupperArrayWithDelegate<span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> list<span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>E<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> map<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> MutableList<span class="token operator">&lt;</span>E<span class="token operator">?</span><span class="token operator">></span> <span class="token keyword">by</span> list<span class="token punctuation">,</span> MutableMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> E<span class="token operator">></span> <span class="token keyword">by</span> map <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 两个接口中都有，编译器不知道执行哪个，所以这些方法必须得重写</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        map<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">{</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> size<span class="token operator">:</span> Int <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> list<span class="token punctuation">.</span>size <span class="token operator">+</span> map<span class="token punctuation">.</span>size
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token keyword">set</span><span class="token punctuation">(</span>index<span class="token operator">:</span> Int<span class="token punctuation">,</span> element<span class="token operator">:</span> E<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> E<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> list<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">repeat</span><span class="token punctuation">(</span>index <span class="token operator">-</span> list<span class="token punctuation">.</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> element<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"list:<span class="token interpolation variable">$list</span>,map:<span class="token interpolation variable">$map</span>"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="3-属性委托-Delegated-properties"><a href="#3-属性委托-Delegated-properties" class="headerlink" title="3. 属性委托(Delegated properties)"></a>3. 属性委托(Delegated properties)</h2><h3 id="3-1-属性-property"><a href="#3-1-属性-property" class="headerlink" title="3.1 属性(property)"></a>3.1 属性(property)</h3><p>我们先通过对比 Java field 和 kotlin property  来探究一下 kt 中 property 的内部实现方式</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//PersonKotlin 尽量写的像Java好对比 Kotlin 属性背后做的事情</span>
<span class="token keyword">class</span> <span class="token class-name">PersonKotlin</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>age<span class="token operator">:</span> Int<span class="token punctuation">,</span> name<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> var age<span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token operator">=</span> null
        <span class="token comment" spellcheck="true">//Redundant getter 属性的 get/set 方法由编译器自动生成</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> field <span class="token comment" spellcheck="true">//这里的 field = backing field</span>
        <span class="token punctuation">}</span>
        <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            field <span class="token operator">=</span> value
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span> var name<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> null
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> field
        <span class="token punctuation">}</span>
        <span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            field <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//反编译 Java 后的代码</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">PersonKotlin</span> <span class="token punctuation">{</span>
   <span class="token keyword">private</span> Integer age<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//field</span>
   <span class="token keyword">private</span> String name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//field</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> Integer <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span>Integer value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> value<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span>String value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> value<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">public</span> <span class="token function">PersonKotlin</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Intrinsics<span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="property-kotlin-field-java-getField-setField"><a href="#property-kotlin-field-java-getField-setField" class="headerlink" title="property(kotlin)=field(java)+getField()+setField()"></a>property(kotlin)=field(java)+getField()+setField()</h4><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// age 属性背后包含了三个角色，backing field、get、set</span>
<span class="token keyword">private</span> var age<span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token operator">=</span> null
<span class="token comment" spellcheck="true">//等价于下面的代码</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">private</span> Integer age<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> Integer <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Integer var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> var1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="属性引用-Property-Reference"><a href="#属性引用-Property-Reference" class="headerlink" title="属性引用(Property Reference)"></a>属性引用(Property Reference)</h4><p>通过属性引用我们可以更清楚的了解 property 背后的 get 和 set 以及代理信息等</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> ageRef<span class="token operator">:</span> KMutableProperty1<span class="token operator">&lt;</span>PersonKotlin<span class="token punctuation">,</span> Int<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> PersonKotlin<span class="token operator">::</span>age
<span class="token comment" spellcheck="true">//PersonKotlin::age 类名获取的属性引用不包含 receiver，操作时需要传递一个</span>
<span class="token keyword">val</span> personKotlin <span class="token operator">=</span> <span class="token function">PersonKotlin</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"Jay"</span><span class="token punctuation">)</span>
ageRef<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>personKotlin<span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span>ageRef<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>personKotlin<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//22</span>
<span class="token comment" spellcheck="true">//public actual fun set(receiver: T, value: V)</span>
<span class="token comment" spellcheck="true">//public actual fun get(receiver: T): V</span>
<span class="token comment" spellcheck="true">//receiver - 用于获取属性值的接收器。 例如，如果这是该类的成员属性，则它应该是类实例，如果这是顶级扩展属性，则它应该是扩展接收器</span>

<span class="token comment" spellcheck="true">//测试自定义属性委托后获取属性的委托信息</span>
<span class="token keyword">val</span> nameRef<span class="token operator">:</span> KProperty0<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> personKotlin<span class="token operator">::</span>name
<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"personKotlin: "</span> <span class="token operator">+</span> personKotlin<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"nameRef: "</span> <span class="token operator">+</span> nameRef<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"personKotlin.name: "</span> <span class="token operator">+</span> personKotlin<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//取： is KMutableProperty -> javaField?.isAccessible ?: true &amp;&amp; javaGetter?.isAccessible ?: true &amp;&amp;javaSetter?.isAccessible ?: true</span>
<span class="token comment" spellcheck="true">//存： is KMutableProperty -> { javaField?.isAccessible = value javaGetter?.isAccessible = value javaSetter?.isAccessible = value }</span>
<span class="token comment" spellcheck="true">//设置是否访问，只有设置为 true 才可以拿到 属性引用中的委托信息（如果被委托了）这个属性需要单独引入 kotlin-reflect 库</span>
nameRef<span class="token punctuation">.</span>isAccessible <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment" spellcheck="true">//如果这是一个委托属性，则返回委托的值，如果此属性未委托，则返回null</span>
<span class="token keyword">val</span> nameDelegate <span class="token operator">=</span> nameRef<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"nameDelegate： <span class="token interpolation variable">$nameDelegate</span>"</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//返回委托信息</span>
<span class="token function">println</span><span class="token punctuation">(</span>nameRef<span class="token punctuation">.</span>getter<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//相当于调用 get 方法</span>
<span class="token comment" spellcheck="true">//personKotlin: 1751075886</span>
<span class="token comment" spellcheck="true">//nameRef: -954731934</span>
<span class="token comment" spellcheck="true">//thisRef:1751075886</span>
<span class="token comment" spellcheck="true">//property:-954731934</span>
<span class="token comment" spellcheck="true">//personKotlin.name: 88377</span>
<span class="token comment" spellcheck="true">//可以看到属性引用类和它的 receiver 在委托类和这里的 hashCode 相同</span>

<span class="token comment" spellcheck="true">//com.jay.lib_kotlin.delegate.MyDelegate@5a63f509</span>
<span class="token comment" spellcheck="true">//YYY</span>

<span class="token comment" spellcheck="true">//测试lazy 属性代理方式</span>
<span class="token keyword">val</span> sexRef<span class="token operator">:</span> KProperty0<span class="token operator">&lt;</span>String<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> personKotlin<span class="token operator">::</span>sex
personKotlin<span class="token punctuation">.</span>sex
sexRef<span class="token punctuation">.</span>isAccessible <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token function">println</span><span class="token punctuation">(</span>sexRef<span class="token punctuation">.</span><span class="token function">getDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//获取的代理信息就是lazy代码块中的值：sex is male</span>


<span class="token comment" spellcheck="true">//测试 属性引用的类型</span>
<span class="token keyword">val</span> kMutableProperty0<span class="token operator">:</span> KMutableProperty0<span class="token operator">&lt;</span>Int<span class="token operator">></span> <span class="token operator">=</span> <span class="token operator">::</span>sex <span class="token comment" spellcheck="true">//sex 是顶级属性</span>
<span class="token keyword">val</span> s <span class="token operator">=</span> kMutableProperty0 <span class="token keyword">as</span> CallableReference
<span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>owner<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//file class com.jay.lib_kotlin.property.PersonKotlinKt</span>
<span class="token comment" spellcheck="true">//属性引用的类型是 CallableReference</span></code></pre>
<p><strong>receiver</strong>：属性值的接收器。 例如，如果这是该类的成员属性，则它应该是类实例，如果这是顶级扩展属性，则它应该是扩展接收器</p>
<p><strong>CallableReference</strong>：是 Kotlin 编译器为可调用引用类生成的所有类的超类</p>
<h3 id="3-2-属性委托实现原理"><a href="#3-2-属性委托实现原理" class="headerlink" title="3.2 属性委托实现原理"></a>3.2 属性委托实现原理</h3><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">open</span> <span class="token keyword">class</span> FooBy <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//只要在by关键字后面带有一个委托对象，这个对象不一定要实现特定的接口，只要包含了getValue/setValue方法、那它就能作为一个代理属性来使用。</span>
    <span class="token keyword">val</span> y <span class="token keyword">by</span> <span class="token function">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> w<span class="token operator">:</span> String <span class="token keyword">by</span> <span class="token function">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> MyDelegate <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">"YYY"</span>
    <span class="token comment" spellcheck="true">//todo 委托类里面必须提供 getValue 方法，或者扩展这个方法也可</span>
    operator <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    operator <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> s<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> s
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>反编译Java后的代码</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FooBy</span> <span class="token punctuation">{</span>
   <span class="token comment" spellcheck="true">// $FF: synthetic field</span>
   <span class="token keyword">static</span> <span class="token keyword">final</span> KProperty<span class="token punctuation">[</span><span class="token punctuation">]</span> $$delegatedProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KProperty</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">property1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PropertyReference1Impl</span><span class="token punctuation">(</span>FooBy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"getY()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">mutableProperty1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MutablePropertyReference1Impl</span><span class="token punctuation">(</span>FooBy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"getW()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> MyDelegate y$delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> MyDelegate w$delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y$delegate<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token annotation punctuation">@NotNull</span>
   <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getW</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>w$delegate<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setW</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> String var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Intrinsics<span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> <span class="token string">"&lt;set-?>"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>w$delegate<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>当调用下面的代码时，就会调用到 FooBy.y 的 get 方法</p>
<pre><code>val foo = FooBy()
println(foo.y)</code></pre><p>看一下反编译后的 getY 方法，</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@NotNull</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getY</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>y$delegate<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>看一下 <code>y$delegate</code> 是什么 ,其实就是我们的代理类并在 FooBy 类构建的时候已经初始化</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@NotNull</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> MyDelegate y$delegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>再看看MyDelegate中的的 getValue 方法, 就是我们在代理类中必须提供的方法</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Java code</span>
<span class="token annotation punctuation">@NotNull</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> Object thisRef<span class="token punctuation">,</span> <span class="token annotation punctuation">@NotNull</span> KProperty property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Intrinsics<span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>thisRef<span class="token punctuation">,</span> <span class="token string">"thisRef"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   Intrinsics<span class="token punctuation">.</span><span class="token function">checkNotNullParameter</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> <span class="token string">"property"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>到这里我们就可以看清了整个委托流程了</p>
<ul>
<li>当类中有属性被委托时，Kotlin 会在当前类中添加委托类的实例并在实例化当前类时实例化委托类( y$delegate)，同时$$delegatedProperties 数组也是在类初始化时创建完成，里面方式所有属性的反射类信息</li>
<li>当要获取委托属性时，会调用到它的 get 方法，而 get 方法返回的是代理类的 getValue 方法</li>
<li>getValue 方法是我们自己实现的，最终代理属性就会通过 getValue  方法赋上值了</li>
<li>setValue 时还会把 属性 的backing field 传过去</li>
</ul>
<h3 id="3-3-PropertyReferenceImpl"><a href="#3-3-PropertyReferenceImpl" class="headerlink" title="3.3 PropertyReferenceImpl"></a>3.3 PropertyReferenceImpl</h3><p>委托流程搞清楚了，我们再来看看 getValue 方法中 <code>thisRef: Any</code>， <code>property: KProperty&lt;*&gt;</code> 这两个参数是怎么来的，干什么用的</p>
<p>thisRef 这个参数是业务类本身可以看到就是在调用 getValue 方法时传递的 this</p>
<p>property 是委托属性的描述类 <code>KProperty</code> ,它是从这个数组里取的 <code>$$delegatedProperties[0]</code>，这个数组也是构建业务类时由Kotlin自动生成的，存放的是描述类属性的 KProperty 类型</p>
<p><code>Reflection.property1</code>  是一个工厂函数，将传入的参数返回</p>
<p>PropertyReference1Impl 的父类也间接实现了 KProperty 接口，所以这里可以强转</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//$$delegatedProperties</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> KProperty<span class="token punctuation">[</span><span class="token punctuation">]</span> $$delegatedProperties <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name">KProperty</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">property1</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">PropertyReference1Impl</span><span class="token punctuation">(</span>FooBy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">,</span> <span class="token string">"getY()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">mutableProperty1</span><span class="token punctuation">(</span>
  <span class="token keyword">new</span> <span class="token class-name">MutablePropertyReference1Impl</span><span class="token punctuation">(</span>FooBy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> <span class="token string">"getW()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>再看一下属性引用实现类 PropertyReference1Impl  的构造参数 </p>
<p>PropertyReference1Impl 类的构造器最终会调用到它的父类  CallableReference</p>
<p><strong>CallableReference</strong>：是 Kotlin 编译器为可调用引用类生成的所有类的超类。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">"1.4"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token function">PropertyReference1Impl</span><span class="token punctuation">(</span>Class owner<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> int flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>NO_RECEIVER<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//NO_RECEIVER 如果属性没有 receiver 构造时会缺省添加一个 NO_RECEIVER</span>
<span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">"1.1"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> static <span class="token keyword">final</span> Object NO_RECEIVER <span class="token operator">=</span> NoReceiver<span class="token punctuation">.</span>INSTANCE<span class="token punctuation">;</span>
<span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">"1.2"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> static <span class="token keyword">class</span> NoReceiver implements Serializable <span class="token punctuation">{</span>
    <span class="token keyword">private</span> static <span class="token keyword">final</span> NoReceiver INSTANCE <span class="token operator">=</span> new <span class="token function">NoReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> Object <span class="token function">readResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> throws ObjectStreamException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INSTANCE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//CallableReference</span>
<span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span>version <span class="token operator">=</span> <span class="token string">"1.4"</span><span class="token punctuation">)</span>
<span class="token keyword">protected</span> <span class="token function">CallableReference</span><span class="token punctuation">(</span>Object receiver<span class="token punctuation">,</span> Class owner<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> boolean isTopLevel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>receiver <span class="token operator">=</span> receiver<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//可调用对象的属性值的接收器。 例如：类实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>owner <span class="token operator">=</span> owner<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//可调用对象所在的类或包</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//可调用对象的 Kotlin 名称，即在源代码中声明的名</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>signature <span class="token operator">=</span> signature<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//可调用对象的 JVM 签名。如果这是一个属性引用，则返回其 getter 的 JVM 签名，例如“getFoo(LjavalangString;)I”。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isTopLevel <span class="token operator">=</span> isTopLevel<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//是否高等类型(文件中还是类中)，0 false; 1 true</span>
<span class="token punctuation">}</span></code></pre>
<p>利用Java的实现方式简单总结以下Kotlin 属性委托的背后原理</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">final</span> Field<span class="token punctuation">[</span><span class="token punctuation">]</span> delegatedProperties <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> NameDelegate nameDelegate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NameDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nameDelegate<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> delegatedProperties<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">NameDelegate</span> <span class="token punctuation">{</span>
  String <span class="token function">getValue</span><span class="token punctuation">(</span>Person thisRef<span class="token punctuation">,</span> Field property<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"Jay"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="3-4-简化属性委托的内置接口们"><a href="#3-4-简化属性委托的内置接口们" class="headerlink" title="3.4 简化属性委托的内置接口们"></a>3.4 简化属性委托的内置接口们</h3><p>Kotlin 内置的属性委托功能是<strong>属性委托类</strong>，不能像普通的委托模式一样通过接口或集成的方式来约束交互的方法和类型，做不了两方约束，但是可以通过泛型+接口约束一下委托类，也能达到一部分约束的效果。</p>
<p>Kotlin 标准库中提供了三个接口来简化委托类的实现</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//val 属性</span>
<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token keyword">interface</span> ReadOnlyProperty<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> <span class="token keyword">out</span> V<span class="token operator">></span>
<span class="token comment" spellcheck="true">//var 属性</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> ReadWriteProperty<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token operator">:</span> ReadOnlyProperty<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> V<span class="token operator">></span>
<span class="token comment" spellcheck="true">//创建委托类的工厂接口</span>
<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token keyword">interface</span> PropertyDelegateProvider<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> <span class="token keyword">out</span> D<span class="token operator">></span>
<span class="token comment" spellcheck="true">//T：拥有委托属性的对象类型。 </span>
<span class="token comment" spellcheck="true">//V：属性值的类型。</span>
<span class="token comment" spellcheck="true">//D：委托类的类型</span></code></pre>
<p>看一下三个接口的接口和方法签名</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token keyword">interface</span> ReadOnlyProperty<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> <span class="token keyword">out</span> V<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> operator <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> T<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> V
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> ReadWriteProperty<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token operator">:</span> ReadOnlyProperty<span class="token operator">&lt;</span>T<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> operator <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> T<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> V
    <span class="token keyword">public</span> operator <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> T<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> V<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token annotation builtin">@SinceKotlin</span><span class="token punctuation">(</span><span class="token string">"1.4"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token keyword">interface</span> PropertyDelegateProvider<span class="token operator">&lt;</span><span class="token keyword">in</span> T<span class="token punctuation">,</span> <span class="token keyword">out</span> D<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> operator <span class="token keyword">fun</span> <span class="token function">provideDelegate</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> T<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> D
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//前两个直接用就行，看一个 PropertyDelegateProvider 的使用场景</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> provider <span class="token operator">=</span> PropertyDelegateProvider<span class="token operator">&lt;</span>FooBy<span class="token punctuation">,</span> MyDelegate<span class="token operator">></span> <span class="token punctuation">{</span> thisRef<span class="token punctuation">,</span> property <span class="token operator">-></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>thisRef<span class="token punctuation">.</span>y <span class="token operator">==</span> <span class="token string">"YYY"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">MyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">MyDelegate2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//MyDelegate2:MyDelegate</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>看一下他们几个综合使用的情况，同时也可以看到kt语音的强大，同样的功能,代码可以从十几行到三行再到一行。yyds!!!</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> provider1 <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> PropertyDelegateProvider<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> ReadWriteProperty<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> Int<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">provideDelegate</span><span class="token punctuation">(</span>
            thisRef<span class="token operator">:</span> FooReadWrite<span class="token punctuation">,</span>
            property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> Int<span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">object</span> <span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> Int<span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> result<span class="token operator">=</span><span class="token number">1024</span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> FooReadWrite<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Int <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> result
                <span class="token punctuation">}</span>
                <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> FooReadWrite<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token operator">=</span>value
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//lambda 简化版本</span>
<span class="token keyword">val</span> provider2<span class="token operator">:</span> PropertyDelegateProvider<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> ReadOnlyProperty<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> Int<span class="token operator">></span><span class="token operator">></span> <span class="token operator">=</span>
    PropertyDelegateProvider<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> ReadOnlyProperty<span class="token operator">&lt;</span>FooReadWrite<span class="token punctuation">,</span> Int<span class="token operator">></span><span class="token operator">></span> <span class="token punctuation">{</span> pThisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> pProperty<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token operator">-></span>ReadOnlyProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> Int<span class="token operator">></span> <span class="token punctuation">{</span> thisRef<span class="token punctuation">,</span> property <span class="token operator">-></span> <span class="token number">1025</span> <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//智能类型推导再简化版本</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> provider3 <span class="token operator">=</span>PropertyDelegateProvider <span class="token punctuation">{</span> _<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> _ <span class="token operator">-></span> ReadOnlyProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> Int<span class="token operator">></span> <span class="token punctuation">{</span> _<span class="token punctuation">,</span> _ <span class="token operator">-></span> <span class="token number">1026</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token keyword">val</span> delegate1<span class="token operator">:</span> Int <span class="token keyword">by</span> provider1
<span class="token keyword">val</span> delegate2<span class="token operator">:</span> Int <span class="token keyword">by</span> provider2
<span class="token keyword">val</span> delegate3<span class="token operator">:</span> Int <span class="token keyword">by</span> provider3</code></pre>
<h2 id="4-属性委托在-Kotlin-Api-中的运用"><a href="#4-属性委托在-Kotlin-Api-中的运用" class="headerlink" title="4. 属性委托在 Kotlin Api 中的运用"></a>4. 属性委托在 Kotlin Api 中的运用</h2><p>Kotlin 标准库中提供了几种委托</p>
<ul>
<li>映射委托(Map delegation)</li>
<li>延迟属性（lazy properties）: 其值只在首次访问时计算；</li>
<li>可观察属性（observable properties）: 监听器会收到有关此属性变更的通知；</li>
<li>非空属性(Delegates.notNull)</li>
</ul>
<h3 id="4-1-映射委托-Map-delegation"><a href="#4-1-映射委托-Map-delegation" class="headerlink" title="4.1 映射委托(Map delegation)"></a>4.1 映射委托(Map delegation)</h3><p>看一个map 作为属性委托方的示例</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> User <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//委托 val</span>
    <span class="token keyword">val</span> map<span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">mapOf</span><span class="token punctuation">(</span><span class="token string">"name2"</span> <span class="token keyword">to</span> <span class="token string">"Jay"</span><span class="token punctuation">,</span> <span class="token string">"age"</span> <span class="token keyword">to</span> <span class="token number">18</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//可变 map 可以委托 val和var</span>
    <span class="token keyword">val</span> map2<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">mutableMapOf</span><span class="token punctuation">(</span><span class="token string">"name2"</span> <span class="token keyword">to</span> <span class="token string">"Jay"</span><span class="token punctuation">,</span> <span class="token string">"age"</span> <span class="token keyword">to</span> <span class="token number">18</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> name<span class="token operator">:</span> String <span class="token keyword">by</span> map
    <span class="token keyword">var</span> age<span class="token operator">:</span> Int <span class="token keyword">by</span> map2

    <span class="token comment" spellcheck="true">//更新 age 的值，MutableMap 也会同步更新</span>
    <span class="token keyword">fun</span> <span class="token function">setValues</span><span class="token punctuation">(</span>age<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>map 中的 key 必须包含属性名，否则会报下面这个错</p>
<pre class=" language-kotlin"><code class="language-kotlin">Exception <span class="token keyword">in</span> thread <span class="token string">"main"</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>NoSuchElementException<span class="token operator">:</span> Key name2 <span class="token keyword">is</span> missing <span class="token keyword">in</span> the map<span class="token punctuation">.</span></code></pre>
<p>所以在使用这个特性时除非我们完全确定支持映射的结构，否则应该避免基于映射的属性委托，要不然委托的类可能会失败并抛出异常</p>
<p>还有一种情况当value 为 null 时，只有第四种情况会发生：NullPointerException ，这个问题想了解的可以官方的 <a href="https://youtrack.jetbrains.com/issue/KT-27672" target="_blank" rel="noopener">bug report</a></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> map<span class="token operator">:</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Any<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">hashMapOf</span><span class="token punctuation">(</span><span class="token string">"name"</span> <span class="token keyword">to</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"age"</span> <span class="token keyword">to</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> name<span class="token operator">:</span> String <span class="token keyword">by</span> map
<span class="token keyword">val</span> name<span class="token operator">:</span> String？ <span class="token keyword">by</span> map
<span class="token keyword">var</span> age<span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token keyword">by</span> map
<span class="token keyword">var</span> age<span class="token operator">:</span> Int <span class="token keyword">by</span> map</code></pre>
<p>再来窥探一下 Map delegation 的委托原理</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// $FF: synthetic field</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> KProperty<span class="token punctuation">[</span><span class="token punctuation">]</span> $$delegatedProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KProperty</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">property1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PropertyReference1Impl</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"getName()Ljava/lang/String;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>KProperty<span class="token punctuation">)</span>Reflection<span class="token punctuation">.</span><span class="token function">mutableProperty1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MutablePropertyReference1Impl</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"getAge()Ljava/lang/Integer;"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Map age$delegate<span class="token punctuation">;</span>
<span class="token annotation punctuation">@Nullable</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> Integer <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Map var1 <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>age$delegate<span class="token punctuation">;</span>
   KProperty var3 <span class="token operator">=</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> var4 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>MapsKt<span class="token punctuation">.</span><span class="token function">getOrImplicitDefaultNullable</span><span class="token punctuation">(</span>var1<span class="token punctuation">,</span> var3<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Integer var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Map var2 <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>age$delegate<span class="token punctuation">;</span>
   KProperty var4 <span class="token operator">=</span> $$delegatedProperties<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">boolean</span> var5 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
   var2<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看到，Kotlin 编译器 也生成了KProperty[] 类型的 $$delegatedProperties 和 Map 类型 age$delegate，并在构造时实例化age$delegate </p>
<p>Map相关的委托必要方法在<strong><a href="https://github.com/JetBrains/kotlin/blob/34e57a45f2/libraries/stdlib/src/kotlin/collections/MapAccessors.kt" target="_blank" rel="noopener">MapAccessors</a></strong> 这个类里面</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//Map</span>
<span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>internal<span class="token punctuation">.</span>InlineOnly
<span class="token keyword">public</span> <span class="token keyword">inline</span> operator <span class="token keyword">fun</span> <span class="token operator">&lt;</span>V<span class="token punctuation">,</span> V1 <span class="token operator">:</span> V<span class="token operator">></span> Map<span class="token operator">&lt;</span><span class="token keyword">in</span> String<span class="token punctuation">,</span> <span class="token annotation builtin">@Exact</span> V<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> V1 <span class="token operator">=</span><span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">getOrImplicitDefault</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> V1<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//MutableMap</span>
<span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>jvm<span class="token punctuation">.</span><span class="token function">JvmName</span><span class="token punctuation">(</span><span class="token string">"getVar"</span><span class="token punctuation">)</span>
<span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>internal<span class="token punctuation">.</span>InlineOnly
<span class="token keyword">public</span> <span class="token keyword">inline</span> operator <span class="token keyword">fun</span> <span class="token operator">&lt;</span>V<span class="token punctuation">,</span> V1 <span class="token operator">:</span> V<span class="token operator">></span> MutableMap<span class="token operator">&lt;</span><span class="token keyword">in</span> String<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token annotation builtin">@Exact</span> V<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> V1 <span class="token operator">=</span> <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">getOrImplicitDefault</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token keyword">as</span> V1<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//MutableMap</span>
<span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>internal<span class="token punctuation">.</span>InlineOnly
<span class="token keyword">public</span> <span class="token keyword">inline</span> operator <span class="token keyword">fun</span> <span class="token operator">&lt;</span>V<span class="token operator">></span> MutableMap<span class="token operator">&lt;</span><span class="token keyword">in</span> String<span class="token punctuation">,</span> <span class="token keyword">in</span> V<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> V<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>property<span class="token punctuation">.</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>在访问 age 的 get 时会调用委托 Map 的    <code>(Integer)MapsKt.getOrImplicitDefaultNullable(var1, var3.getName());</code></p>
<p>在访问 age 的 set 时直接调用委托 Map 的put方法</p>
<p>下面是 <strong>getOrImplicitDefaultNullable</strong> 函数</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//JvmName 这个注解是指定从此元素生成的 Java 类或方法的名称。</span>
<span class="token comment" spellcheck="true">//扩展方法编译后会将方法的 reciver 作为第一个参数传入</span>
<span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>jvm<span class="token punctuation">.</span><span class="token function">JvmName</span><span class="token punctuation">(</span><span class="token string">"getOrImplicitDefaultNullable"</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@PublishedApi</span>
<span class="token keyword">internal</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> Map<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">getOrImplicitDefault</span><span class="token punctuation">(</span>key<span class="token operator">:</span> K<span class="token punctuation">)</span><span class="token operator">:</span> V <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">is</span> MapWithDefault<span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOrImplicitDefault</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">getOrElseNullable</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token function">NoSuchElementException</span><span class="token punctuation">(</span><span class="token string">"Key <span class="token interpolation variable">$key</span> is missing in the map."</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>关于 map 的 put 和 get 操作是如何与委托的 getValue 和 setValue 如何联系在一起的 以及map 的 <code>getValue(thisRef: Any?, property: KProperty&lt;*&gt;)</code>方法为什么用 inline 修饰了，这里涉及到Kotlin 1.4 对委托属性的一个优化，稍后再解析 lazy 原理时会详细解释。</p>
<p>Map delegation 的一个实践，将推送消息封装并通知APP</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onNotificationReceivedInApp</span><span class="token punctuation">(</span>
    context<span class="token operator">:</span> Context<span class="token punctuation">,</span>
    title<span class="token operator">:</span> String<span class="token punctuation">,</span>
    summary<span class="token operator">:</span> String<span class="token punctuation">,</span>
    extraMap<span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> extraMap<span class="token punctuation">.</span><span class="token function">withDefault</span> <span class="token punctuation">{</span> <span class="token string">""</span> <span class="token punctuation">}</span>
    <span class="token keyword">val</span> params <span class="token operator">=</span> <span class="token function">NotificationParams</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span>
    EventBus<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">NotificationParams</span><span class="token punctuation">(</span><span class="token keyword">val</span> map<span class="token operator">:</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> title<span class="token operator">:</span> String <span class="token keyword">by</span> map
    <span class="token keyword">val</span> content<span class="token operator">:</span> String <span class="token keyword">by</span> map
<span class="token punctuation">}</span></code></pre>
<h3 id="4-2-延迟属性-lazy-properties"><a href="#4-2-延迟属性-lazy-properties" class="headerlink" title="4.2 延迟属性(lazy properties)"></a>4.2 延迟属性(lazy properties)</h3><p>看一下lazy的简单使用</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> x<span class="token operator">:</span> String <span class="token keyword">by</span> <span class="token function">lazy</span><span class="token punctuation">(</span>LazyThreadSafetyMode<span class="token punctuation">.</span>SYNCHRONIZED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"xxx——lazy"</span><span class="token punctuation">)</span>
    <span class="token string">"xxx——<span class="token interpolation"><span class="token delimiter variable">${</span>index<span class="token operator">++</span><span class="token delimiter variable">}</span></span>"</span>
<span class="token punctuation">}</span>
<span class="token keyword">val</span> y<span class="token operator">:</span> String <span class="token keyword">by</span> <span class="token function">lazy</span><span class="token punctuation">(</span>LazyThreadSafetyMode<span class="token punctuation">.</span>PUBLICATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"yyy——lazy"</span><span class="token punctuation">)</span>
    <span class="token string">"yyy——<span class="token interpolation"><span class="token delimiter variable">${</span>index<span class="token operator">++</span><span class="token delimiter variable">}</span></span>"</span>
<span class="token punctuation">}</span>
<span class="token keyword">val</span> z<span class="token operator">:</span> String <span class="token keyword">by</span> <span class="token function">lazy</span><span class="token punctuation">(</span>LazyThreadSafetyMode<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"zzz——lazy"</span><span class="token punctuation">)</span>
    <span class="token string">"zzz——<span class="token interpolation"><span class="token delimiter variable">${</span>index<span class="token operator">++</span><span class="token delimiter variable">}</span></span>"</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> fooLazy <span class="token operator">=</span> <span class="token function">FooLazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">val</span> thread <span class="token operator">=</span> <span class="token function">thread</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">+</span> fooLazy<span class="token punctuation">.</span>x<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===="</span> <span class="token operator">+</span> fooLazy<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"========="</span> <span class="token operator">+</span> fooLazy<span class="token punctuation">.</span>z<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">//xxx——lazy 和 yyy——lazy 都只执行一次，x=0, y=1</span>
<span class="token comment" spellcheck="true">//zzz——lazy 和 z 的值不能确定会执行几次</span></code></pre>
<p>LazyThreadSafetyMode 有三种模式作用是指定 [Lazy] 实例如何在多个线程之间同步初始化。</p>
<ul>
<li>SYNCHRONIZED: 锁用于确保只有一个线程可以初始化[Lazy]实例。</li>
<li>PUBLICATION: 并发访问未初始化的[Lazy]实例值时，可以多次调用Initializer函数，但是只有第一个返回的值将用作[Lazy]实例的值。</li>
<li>NONE: 不使用锁来同步对 [Lazy] 实例值的访问；如果从多个线程访问该实例，可能会发生线程安全问题。除非保证 [Lazy] 实例永远不会从多个线程初始化，否则不应使用此模式。</li>
</ul>
<h4 id="lazy-原理解析"><a href="#lazy-原理解析" class="headerlink" title="lazy 原理解析"></a>lazy 原理解析</h4><p>受托对象是Lazy</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@NotNull</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> Lazy x$delegate<span class="token punctuation">;</span></code></pre>
<p>受托对象在委托者构造方法中实例化</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token function">FooLazy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>x$delegate <span class="token operator">=</span> LazyKt<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span>LazyThreadSafetyMode<span class="token punctuation">.</span>SYNCHRONIZED<span class="token punctuation">,</span> <span class="token punctuation">(</span>Function0<span class="token punctuation">)</span><span class="token punctuation">(</span>new <span class="token function">Function0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// $FF: synthetic method</span>
      <span class="token comment" spellcheck="true">// $FF: bridge method</span>
      <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token annotation builtin">@NotNull</span>
      <span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         String var1 <span class="token operator">=</span> <span class="token string">"xxx——lazy"</span><span class="token punctuation">;</span>
         boolean var2 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
         System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
         StringBuilder var10000 <span class="token operator">=</span> <span class="token punctuation">(</span>new <span class="token function">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"xxx——"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         FooLazy var10001 <span class="token operator">=</span> FooLazy<span class="token punctuation">.</span>this<span class="token punctuation">;</span>
         int var3<span class="token punctuation">;</span>
         var10001<span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token punctuation">(</span>var3 <span class="token operator">=</span> var10001<span class="token punctuation">.</span>index<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> var10000<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>var3<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>可以看到 <code>x$delegate</code>  是通过 LazyKt.lazy() 方法实例化的，两个参数分别是线程安全模式类型和一个接口回调</p>
<p>当调用x 的 get 方法时 反回了受托者的 getValue 方法 并没有调用 lazy 的扩展方法：LazyKt.getValue(thisRef: Any?, property: KProperty&lt;*&gt;) </p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> String <span class="token function">getX</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Lazy var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>x$delegate<span class="token punctuation">;</span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>再看一下 lazy 是如何定义委托方法 getValue 的</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token label symbol">@kotlin</span><span class="token punctuation">.</span>internal<span class="token punctuation">.</span>InlineOnly
<span class="token keyword">public</span> <span class="token keyword">inline</span> operator <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token operator">=</span> value</code></pre>
<p>这里有没有注意到 lazy 利用属性委托的方式是不同的</p>
<ul>
<li>没有自动生成属性数组  <code>KProperty[] $$delegatedProperties</code> </li>
<li>getX 时最终返回时调用的也不是 <code>getValue(thisRef: Any?, property: KProperty&lt;*&gt;)</code></li>
<li>lazy 的  <code>getValue(thisRef: Any?, property: KProperty&lt;*&gt;)</code> 方法是用 <strong>inline</strong> 修饰的 并且添加了<code>@kotlin.internal.InlineOnly</code> 注解，map 委托 也是这样的操作</li>
</ul>
<p>其实这里是Kotlin 1.4 做的优化，当某些委托属性不会使用 KProperty。对于他们来说，在 <code>$$delegatedProperties</code> 中生成一个KProperty对象是多余的。Kotlin 1.4 版本将优化此类情况。如果委托的属性运算符是内联的，并且没有使用 KProperty 参数，则不会生成相应的反射对象。如果委托属性中有没有采用 inline 修饰的 ， 最终生成的<code>$$delegatedProperties</code>  数组中也之会单独生成它自己的反射对象，详细说明可以看官方的这篇博客</p>
<p><a href="https://blog.jetbrains.com/kotlin/2019/12/what-to-expect-in-kotlin-1-4-and-beyond/" target="_blank" rel="noopener">What to Expect in Kotlin 1.4 and Beyond | Optimized delegated properties</a></p>
<blockquote>
<p>内联实际上是如何工作的？</p>
<p>粗略地说，内联采用被内联的函数的字节码，并将其插入到调用处，因此内联函数声明不必在调用处可见。</p>
<p><code>@kotlin.internal.InlineOnly</code> 注解的作用？</p>
<p><code>InlineOnly</code> 意味着与此 Kotlin 函数对应的 Java 方法被标记为私有，因此 Java 代码无法访问它（这是调用内联函数而不实际内联它的唯一方法）。这个注释还没有得到很好的验证，官方目前只在内部使用，很有可能稍后将其公之于众。</p>
</blockquote>
<p>所以 lazy 和 map 的属性委托在 Kotlin 4.1 都是做了优化的，lazy 属性在调用 getter 时实际上是调用的的是 Lazy<t> 中 value 的 getter，map 属性在调用 getter/setter 时 实际上最终调用的也是 map 的 get/put 方法。</t></p>
<p>看一下 lazy 函数签名</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> actual <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">lazy</span><span class="token punctuation">(</span>mode<span class="token operator">:</span> LazyThreadSafetyMode<span class="token punctuation">,</span> initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span>
    <span class="token keyword">when</span> <span class="token punctuation">(</span>mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LazyThreadSafetyMode<span class="token punctuation">.</span>SYNCHRONIZED <span class="token operator">-></span> <span class="token function">SynchronizedLazyImpl</span><span class="token punctuation">(</span>initializer<span class="token punctuation">)</span>
        LazyThreadSafetyMode<span class="token punctuation">.</span>PUBLICATION <span class="token operator">-></span> <span class="token function">SafePublicationLazyImpl</span><span class="token punctuation">(</span>initializer<span class="token punctuation">)</span>
        LazyThreadSafetyMode<span class="token punctuation">.</span>NONE <span class="token operator">-></span> <span class="token function">UnsafeLazyImpl</span><span class="token punctuation">(</span>initializer<span class="token punctuation">)</span>
    <span class="token punctuation">}</span></code></pre>
<h4 id="SynchronizedLazyImpl"><a href="#SynchronizedLazyImpl" class="headerlink" title="SynchronizedLazyImpl"></a>SynchronizedLazyImpl</h4><p>SynchronizedLazyImpl 采用 DCL 方式确保线程安全</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">class</span> SynchronizedLazyImpl<span class="token operator">&lt;</span><span class="token keyword">out</span> T<span class="token operator">></span><span class="token punctuation">(</span>initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">,</span> lock<span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> initializer
    <span class="token annotation builtin">@Volatile</span> <span class="token comment" spellcheck="true">// 用内存可见性来检查是否在其他线程初始化过，同时也会禁止指令重排序防止_value拿到不完整的实例</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> _value<span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span> UNINITIALIZED_VALUE
    <span class="token comment" spellcheck="true">//实例使用自身进行同步</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> lock <span class="token operator">=</span> lock <span class="token operator">?:</span> <span class="token keyword">this</span>
    <span class="token comment" spellcheck="true">//Lazy 接口的 value 属性用于获取当前 Lazy 实例的延迟初始化值。一旦初始化后，它不得在此 Lazy 实例的剩余生命周期内更改。</span>
    <span class="token keyword">val</span> value<span class="token operator">:</span> T
        <span class="token comment" spellcheck="true">// 重写 get 来保证懒加载，只在使用的时候才执行函数</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//局部变量可以将性能提高25%以上</span>
            <span class="token keyword">val</span> _v1 <span class="token operator">=</span> _value
            <span class="token comment" spellcheck="true">//检查单例实例是否已初始化。如果它被初始化就返回实例。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_v1 <span class="token operator">!==</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> _v1 <span class="token keyword">as</span> T
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//到这里还没有初始化，但我们不能确定，因为可能有多个其他线程可能同时初始化了它。</span>
            <span class="token comment" spellcheck="true">//所以为了以防万一，这里需要添加一把互斥锁来保证只有一个线程去实例化实例对象。</span>
            <span class="token keyword">return</span> <span class="token function">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//再次将实例分配给局部变量以检查它是否被其他线程初始化，而当前线程被阻止进入锁定区域。</span>
                <span class="token keyword">val</span> _v2 <span class="token operator">=</span> _value
                <span class="token comment" spellcheck="true">//如果它已经被其它线程初始化了，当前线程也能感知他的存在了，直接返回实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_v2 <span class="token operator">!==</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
                    <span class="token punctuation">(</span>_v2 <span class="token keyword">as</span> T<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//到这里该实例仍未初始化，因此我们可以安全地（没有其他线程可以进入该区域）创建一个实例了。</span>
                    <span class="token keyword">val</span> typedValue <span class="token operator">=</span> initializer<span class="token operator">!!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//执行 Function 对象的 invoke 并将函数的返回值缓存起来</span>
                    _value <span class="token operator">=</span> typedValue <span class="token comment" spellcheck="true">//_value赋值通知其它线程别进来了，拿走用吧</span>
                    initializer <span class="token operator">=</span> <span class="token keyword">null</span> <span class="token comment" spellcheck="true">//initializer在当前类实例已经没用了</span>
                    typedValue <span class="token comment" spellcheck="true">// 返回最终的结果给 value</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>看不惯这种DCL也可以恢复成传统方式看一下</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">val</span> value<span class="token operator">:</span> T
    <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//局部变量将性能提高了 25% Joshua Bloch “Effective Java, Second Edition”，第 3 页。 283-284</span>
        <span class="token keyword">var</span> _v1 <span class="token operator">=</span> _value
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_v1 <span class="token operator">==</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 再次将实例分配给局部变量以检查它是否被其他线程初始化，而当前线程被阻止进入锁定区域。</span>
                <span class="token comment" spellcheck="true">// 如果它被初始化，当前线程也能感知他的存在了。</span>
                _v1 <span class="token operator">=</span> _value
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_v1 <span class="token operator">==</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 该实例仍未初始化，因此我们可以安全地（没有其他线程可以进入该区域）创建一个实例并将其赋值给我们的单例引用。</span>
                    _v1 <span class="token operator">=</span> initializer<span class="token operator">!!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    initializer <span class="token operator">=</span> <span class="token keyword">null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> _v1 <span class="token keyword">as</span> T
    <span class="token punctuation">}</span></code></pre>
<h4 id="SafePublicationLazyImpl"><a href="#SafePublicationLazyImpl" class="headerlink" title="SafePublicationLazyImpl"></a>SafePublicationLazyImpl</h4><p><strong>AtomicReferenceFieldUpdater</strong> ：原子更新器是基于反射的工具类，用来对某个类中，被volatile修饰的字段进行原子更新。</p>
<p>通过调用AtomicReferenceFieldUpdater的静态方法<code>newUpdater</code>就能创建它的实例，该方法要接收三个参数：包含该字段所在的类、将被更新的对象的类型、将被更新的字段的名称</p>
<p><code>compareAndSet</code> 如果期望值和字段当前值相等，说明目前是最新的值可以进行更新返回 true 同时原子地将字段设置为给定的更新值。</p>
<p><code>getAndSet</code>原子地将此更新程序管理的给定对象的字段设置为给定值并返回旧值。</p>
<p>原子更新器的使用存在比较苛刻的条件如下</p>
<ul>
<li>操作的字段不能是static类型。</li>
<li>操作的字段不能是final类型的，因为final根本没法修改。</li>
<li>字段必须是volatile修饰的，也就是数据本身是读一致的。</li>
<li>属性必须对当前的Updater所在的区域是可见的，如果不是当前类内部进行原子更新器操作不能使用private，protected子类操作父类时修饰符必须是protect权限及以上，如果在同一个package下则必须是default权限及以上，也就是说无论何时都应该保证操作类与被操作类间的可见性。</li>
</ul>
<blockquote>
<p>CAS，Compare and Swap即比较并交换，设计并发算法时常用到的一种技术，java.util.concurrent包全完建立在CAS之上，没有CAS也就没有此包，可见CAS的重要性。当前的处理器基本都支持CAS，只不过不同的厂家的实现不一样罢了。<strong>CAS有三个操作数：内存值V、旧的预期值A、要修改的值B，当且仅当预期值A和内存值V相同时，将内存值修改为B并返回true，否则什么都不做并返回false</strong>。</p>
<p>Unsafe，JDK中的一个类，它提供了硬件级别的<strong>原子操作</strong>。</p>
</blockquote>
<p>compareAndSet 方法调用流程</p>
<pre class=" language-java"><code class="language-java">
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Unsafe U <span class="token operator">=</span> sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Unsafe<span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span>T obj<span class="token punctuation">,</span> V expect<span class="token punctuation">,</span> V update<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">accessCheck</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">valueCheck</span><span class="token punctuation">(</span>update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> U<span class="token punctuation">.</span><span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span>Object var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> Object var4<span class="token punctuation">,</span> Object var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>看一个例子了解 <code>AtomicReferenceFieldUpdater</code> 的使用方式</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceFieldUpdaterTest</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// T:持有可更新字段的对象的类型</span>
    <span class="token comment" spellcheck="true">// V:字段的类型</span>
    AtomicReferenceFieldUpdater<span class="token operator">&lt;</span>Dog<span class="token punctuation">,</span> String<span class="token operator">></span> updater <span class="token operator">=</span>
        <span class="token comment" spellcheck="true">// 包含该字段所在的类、将被更新的对象的类、将被更新的字段的名称</span>
        AtomicReferenceFieldUpdater<span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span>Dog<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Dog dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 如果期望值和字段当前值相等，说明目前是最新的值可以进行更新，则原子地将字段设置为给定的更新值。</span>
    <span class="token comment" spellcheck="true">// 参数：</span>
    <span class="token comment" spellcheck="true">// obj: 字段所在对象</span>
    <span class="token comment" spellcheck="true">// expect - 期望值</span>
    <span class="token comment" spellcheck="true">// update - 新值</span>
    <span class="token comment" spellcheck="true">// 返回：如果成功则为true</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dog1 默认值</span>
    <span class="token keyword">boolean</span> result <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>dog<span class="token punctuation">,</span> <span class="token string">"dog1"</span><span class="token punctuation">,</span> <span class="token string">"dog2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// true 修改成功</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dog2 修改后的的值</span>
    <span class="token keyword">boolean</span> result2 <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>dog<span class="token punctuation">,</span> <span class="token string">"dog1"</span><span class="token punctuation">,</span> <span class="token string">"dog3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false 修改失败</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dog2 还是原来的值</span>

    <span class="token comment" spellcheck="true">// 原子地将此更新程序管理的给定对象的字段设置为给定值并返回旧值。</span>
    <span class="token comment" spellcheck="true">// 参数：</span>
    <span class="token comment" spellcheck="true">// obj – 更新字段的对象</span>
    <span class="token comment" spellcheck="true">// newValue – 新值</span>
    <span class="token comment" spellcheck="true">// 返回：之前的的值</span>
    String result3 <span class="token operator">=</span> updater<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span>dog<span class="token punctuation">,</span> <span class="token string">"dog4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dog2  原来的值</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// dog4 修改后的值</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Dog</span> <span class="token punctuation">{</span>
  <span class="token keyword">volatile</span> String name <span class="token operator">=</span> <span class="token string">"dog1"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>SafePublicationLazyImpl 使用 AtomicReferenceFieldUpdater 来保证 _value 属性的原子操作。支持同时多个线程调用，并且可以在全部或部分线程上同时进行初始化。如果某个值已由另一个线程初始化，则将返回该值而不执行初始化。</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">class</span> SafePublicationLazyImpl<span class="token operator">&lt;</span><span class="token keyword">out</span> T<span class="token operator">></span><span class="token punctuation">(</span>initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>
    <span class="token annotation builtin">@Volatile</span> <span class="token keyword">private</span> <span class="token keyword">var</span> initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> initializer
    <span class="token annotation builtin">@Volatile</span> <span class="token keyword">private</span> <span class="token keyword">var</span> _value<span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span> UNINITIALIZED_VALUE
    <span class="token keyword">private</span> <span class="token keyword">val</span> <span class="token keyword">final</span><span class="token operator">:</span> Any <span class="token operator">=</span> UNINITIALIZED_VALUE
    <span class="token keyword">override</span> <span class="token keyword">val</span> value<span class="token operator">:</span> T
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> value <span class="token operator">=</span> _value
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!==</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> value <span class="token keyword">as</span> T
            <span class="token punctuation">}</span>
            <span class="token keyword">val</span> initializerValue <span class="token operator">=</span> initializer
            <span class="token comment" spellcheck="true">//如果在这里看到初始值已经为 null，则表示该值已被另一个线程设置过了，直接返回 _value ，否则就初始化</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>initializerValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> newValue <span class="token operator">=</span> <span class="token function">initializerValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//执行 Function 对象的 invoke 并将函数返回值原子化赋值给 _value</span>
                <span class="token comment" spellcheck="true">//如果_value的值是UNINITIALIZED_VALUE说明还没有线程初始化它，此时可以将newValue设置给_value</span>
                  <span class="token keyword">if</span> <span class="token punctuation">(</span>valueUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> UNINITIALIZED_VALUE<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    initializer <span class="token operator">=</span> <span class="token keyword">null</span>
                    <span class="token keyword">return</span> newValue <span class="token comment" spellcheck="true">//只有唯一的线程会从这里返回，其它都走下面的返回了</span>
                <span class="token punctuation">}</span>
              <span class="token comment" spellcheck="true">//如果_value的值不是UNINITIALIZED_VALUE，说明其它线程已经初始化完了，当前线程直接返回_value就行了</span>
            <span class="token punctuation">}</span>
            <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> _value <span class="token keyword">as</span> T
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//如果一个序列化类中含有Object writeReplace()方法，那么实际序列化的对象将是作为writeReplace方法返回值的对象，</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">writeReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token operator">=</span> <span class="token function">InitializedLazyImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//初始化一个原子更新器：保证原子操作的字段是 _value</span>
        <span class="token keyword">private</span> <span class="token keyword">val</span> valueUpdater <span class="token operator">=</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span>AtomicReferenceFieldUpdater<span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span>
            SafePublicationLazyImpl<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span>
            Any<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span>
            <span class="token string">"_value"</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="UnsafeLazyImpl"><a href="#UnsafeLazyImpl" class="headerlink" title="UnsafeLazyImpl"></a>UnsafeLazyImpl</h4><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">class</span> UnsafeLazyImpl<span class="token operator">&lt;</span><span class="token keyword">out</span> T<span class="token operator">></span><span class="token punctuation">(</span>initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> initializer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> initializer
    <span class="token keyword">private</span> <span class="token keyword">var</span> _value<span class="token operator">:</span> Any<span class="token operator">?</span> <span class="token operator">=</span> UNINITIALIZED_VALUE
    <span class="token keyword">override</span> <span class="token keyword">val</span> value<span class="token operator">:</span> T
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment" spellcheck="true">//普通的懒加载，只初始化一次，但是在多线程环境下不能保证只执行一次</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_value <span class="token operator">===</span> UNINITIALIZED_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                _value <span class="token operator">=</span> initializer<span class="token operator">!!</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//多线程并发情况下可能出现空指针异常</span>
                initializer <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token punctuation">}</span>
            <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> _value <span class="token keyword">as</span> T
        <span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true">//如果一个序列化类中含有Object writeReplace()方法，那么实际序列化的对象将是作为writeReplace方法返回值的对象，</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">writeReplace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Any <span class="token operator">=</span> <span class="token function">InitializedLazyImpl</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="4-3-NotNullVar"><a href="#4-3-NotNullVar" class="headerlink" title="4.3 NotNullVar"></a>4.3 NotNullVar</h3><p>notNull 可以返回一个经过非空校验的属性值但是该属性值并没有初始化需要人为稍后setValue<br>在分配初始值之前尝试读取属性会导致异常，这也是返回非空属性的原理所在</p>
<blockquote>
<p>非空属性应用场景分析<br>通常，声明为非空类型的属性必须在构造函数中初始化。然而，这通常并不方便。 例如，可以通过依赖注入或在单元测试的 setup 方法中初始化属性。在这种情况下，您不能在构造函数中提供非 null 初始值设定项，但您仍然希望在引用类体内的属性时避免空检查。</p>
<p>notNull VS lateinit<br>lateinit 不支持原始类型、只能用在可变属性var<br>notNull 会为每个属性创建委托类 NotNullVar</p>
</blockquote>
<p>notNull  的使用与原理</p>
<pre class=" language-kotlin"><code class="language-kotlin">    <span class="token keyword">var</span> name2<span class="token operator">:</span> String <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> age2<span class="token operator">:</span> Int <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// notNull 会为每个属性创建委托类 NotNullVar</span>
<span class="token comment" spellcheck="true">//    lateinit var age3: Int //lateinit 不支持原始类型</span>
    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> name3<span class="token operator">:</span> String <span class="token comment" spellcheck="true">//lateinit 只能用在 var</span>


<span class="token keyword">public</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T <span class="token operator">:</span> Any<span class="token operator">></span> <span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">NotNullVar</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> NotNullVar<span class="token operator">&lt;</span>T <span class="token operator">:</span> Any<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> value<span class="token operator">:</span> T<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Property <span class="token interpolation"><span class="token delimiter variable">${</span>property<span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span> should be initialized before get."</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="4-4-ObservableProperty"><a href="#4-4-ObservableProperty" class="headerlink" title="4.4 ObservableProperty"></a>4.4 ObservableProperty</h3><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> ObservableProperty<span class="token operator">&lt;</span>V<span class="token operator">></span><span class="token punctuation">(</span>initialValue<span class="token operator">:</span> V<span class="token punctuation">)</span> <span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> value <span class="token operator">=</span> initialValue
    <span class="token keyword">protected</span> <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">beforeChange</span><span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> V<span class="token punctuation">,</span> newValue<span class="token operator">:</span> V<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">protected</span> <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">afterChange</span><span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> V<span class="token punctuation">,</span> newValue<span class="token operator">:</span> V<span class="token punctuation">)</span><span class="token operator">:</span> Unit <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> V <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token operator">?</span><span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> V<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> oldValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value
    <span class="token comment" spellcheck="true">//beforeChange: 在尝试更改属性值之前调用的回调。 调用此回调时，该属性的值尚未更改。 如果回调返回true ，则属性的值被设置为新值，如果回调返回false ，则丢弃新值，属性保持其旧值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">beforeChange</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token comment" spellcheck="true">//afterChange: 进行属性更改后调用的回调。 调用此回调时，该属性的值已更改。</span>
        <span class="token function">afterChange</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="observable-变量值更新后的监听"><a href="#observable-变量值更新后的监听" class="headerlink" title="observable 变量值更新后的监听"></a>observable 变量值更新后的监听</h4><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">observable</span><span class="token punctuation">(</span>initialValue<span class="token operator">:</span> T<span class="token punctuation">,</span> <span class="token keyword">crossinline</span> onChange<span class="token operator">:</span> <span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> T<span class="token punctuation">,</span> newValue<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token operator">=</span>
    <span class="token keyword">object</span> <span class="token operator">:</span> ObservableProperty<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">afterChange</span><span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> T<span class="token punctuation">,</span> newValue<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">onChange</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span></code></pre>
<h4 id="vetoable变量值更新前的拦截"><a href="#vetoable变量值更新前的拦截" class="headerlink" title="vetoable变量值更新前的拦截"></a>vetoable变量值更新前的拦截</h4><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">public</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">vetoable</span><span class="token punctuation">(</span>initialValue<span class="token operator">:</span> T<span class="token punctuation">,</span> <span class="token keyword">crossinline</span> onChange<span class="token operator">:</span> <span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> T<span class="token punctuation">,</span> newValue<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">-></span> Boolean<span class="token punctuation">)</span><span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token operator">?</span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token operator">=</span>
    <span class="token keyword">object</span> <span class="token operator">:</span> ObservableProperty<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>initialValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">beforeChange</span><span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> T<span class="token punctuation">,</span> newValue<span class="token operator">:</span> T<span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token operator">=</span> <span class="token function">onChange</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span></code></pre>
<p>测试代码</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">var</span> items<span class="token operator">:</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token function">mutableListOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> property<span class="token punctuation">,</span> oldValue<span class="token punctuation">,</span> newValue <span class="token operator">-></span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter variable">${</span>property<span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span> : <span class="token interpolation variable">$oldValue</span> -> <span class="token interpolation variable">$newValue</span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> nameAfter<span class="token operator">:</span> String <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token string">"no"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> prop<span class="token punctuation">,</span> old<span class="token punctuation">,</span> new <span class="token operator">-></span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$old</span> -> <span class="token interpolation variable">$new</span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> nameBefore<span class="token operator">:</span> String <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">vetoable</span><span class="token punctuation">(</span><span class="token string">"no"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> prop<span class="token punctuation">,</span> old<span class="token punctuation">,</span> new <span class="token operator">-></span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$old</span> -> <span class="token interpolation variable">$new</span>"</span><span class="token punctuation">)</span>
    <span class="token boolean">true</span> <span class="token comment" spellcheck="true">//返回true 表示 setValue 成功，否则不能覆盖原值</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">onChange</span><span class="token punctuation">(</span>property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> oldValue<span class="token operator">:</span> T<span class="token punctuation">,</span> newValue<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation"><span class="token delimiter variable">${</span>property<span class="token punctuation">.</span>name<span class="token delimiter variable">}</span></span> : <span class="token interpolation variable">$oldValue</span> -> <span class="token interpolation variable">$newValue</span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> age<span class="token operator">:</span> Int <span class="token keyword">by</span> Delegates<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token operator">::</span>onChange<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//运行结果</span>
no <span class="token operator">-></span> first
first <span class="token operator">-></span> second
no <span class="token operator">-></span> <span class="token number">11111</span>
<span class="token number">11111</span> <span class="token operator">-></span> <span class="token number">2222</span>
age <span class="token operator">:</span> <span class="token number">18</span> <span class="token operator">-></span> <span class="token number">33</span>
age <span class="token operator">:</span> <span class="token number">33</span> <span class="token operator">-></span> <span class="token number">55</span>
items <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token punctuation">[</span>new <span class="token keyword">val</span><span class="token punctuation">]</span>
items <span class="token operator">:</span> <span class="token punctuation">[</span>new <span class="token keyword">val</span><span class="token punctuation">]</span> <span class="token operator">-></span> <span class="token punctuation">[</span>new <span class="token keyword">val</span><span class="token punctuation">,</span> new <span class="token number">111</span><span class="token punctuation">]</span></code></pre>
<h2 id="5-属性委托在-Android-上的应用"><a href="#5-属性委托在-Android-上的应用" class="headerlink" title="5. 属性委托在 Android 上的应用"></a>5. 属性委托在 Android 上的应用</h2><h3 id="5-1-ViewBinding"><a href="#5-1-ViewBinding" class="headerlink" title="5.1 ViewBinding"></a>5.1 ViewBinding</h3><pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//1. 借助 lazy 属性委托  + 反射 VB 的 inflate 方法</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> binding<span class="token operator">:</span> ActivityMainBinding <span class="token keyword">by</span> <span class="token function">vb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//2. 借助 lazy 属性委托  + 传递 inflate 方法引用</span>
<span class="token keyword">private</span> <span class="token keyword">val</span> binding<span class="token operator">:</span> ActivityMainBinding <span class="token keyword">by</span> <span class="token function">vb</span><span class="token punctuation">(</span>ActivityMainBinding<span class="token operator">::</span>inflate<span class="token punctuation">)</span></code></pre>
<p><strong><a href="https://github.com/jaydroid1024/VBHelper" target="_blank" rel="noopener">VBHelper</a></strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@MainThread</span>
<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> T <span class="token operator">:</span> ViewBinding<span class="token operator">></span> ComponentActivity<span class="token punctuation">.</span><span class="token function">vb</span><span class="token punctuation">(</span><span class="token keyword">noinline</span> inflateMethodRef<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token operator">=</span>
    <span class="token function">ActivityVBLazy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> T<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> inflateMethodRef<span class="token punctuation">)</span>


<span class="token keyword">class</span> ActivityVBLazy<span class="token operator">&lt;</span>T <span class="token operator">:</span> ViewBinding<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> activity<span class="token operator">:</span> ComponentActivity<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> kClass<span class="token operator">:</span> KClass<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> inflateMethodRef<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>LayoutInflater<span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> cachedBinding<span class="token operator">:</span> T<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> value<span class="token operator">:</span> T
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> viewBinding <span class="token operator">=</span> cachedBinding
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewBinding <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                viewBinding <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>inflateMethodRef <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//借助 lazy 属性委托 + 传递 inflate 方法引用</span>
                    inflateMethodRef<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span>layoutInflater<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">//借助 lazy 属性委托  + 反射绑定类的 inflate 方法</span>
                    <span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"UNCHECKED_CAST"</span><span class="token punctuation">)</span>
                    kClass<span class="token punctuation">.</span>java<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>METHOD_INFLATE<span class="token punctuation">,</span> LayoutInflater<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> activity<span class="token punctuation">.</span>layoutInflater<span class="token punctuation">)</span> <span class="token keyword">as</span> T
                <span class="token punctuation">}</span>
                activity<span class="token punctuation">.</span><span class="token function">setContentView</span><span class="token punctuation">(</span>viewBinding<span class="token punctuation">.</span>root<span class="token punctuation">)</span>
                cachedBinding <span class="token operator">=</span> viewBinding
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> viewBinding
        <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> cachedBinding <span class="token operator">!=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5-2-ViewModel"><a href="#5-2-ViewModel" class="headerlink" title="5.2 ViewModel"></a>5.2 ViewModel</h3><pre class=" language-kotlin"><code class="language-kotlin"><span class="token comment" spellcheck="true">//借助 lazy 属性委托  + ViewModelProvider</span>
<span class="token keyword">val</span> model<span class="token operator">:</span> MyViewModel <span class="token keyword">by</span> <span class="token function">viewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><strong><a href="https://android.googlesource.com/platform/frameworks/support/+/0699f8f5b5aa7d79ba48d57a3710989ae2f50ee3/activity/ktx/src/main/java/androidx/activity/ActivityViewModelLazy.kt" target="_blank" rel="noopener">ActivityViewModelLazy</a></strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@MainThread</span>
<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> VM <span class="token operator">:</span> ViewModel<span class="token operator">></span> ComponentActivity<span class="token punctuation">.</span><span class="token function">viewModels</span><span class="token punctuation">(</span>
    factory<span class="token operator">:</span> ViewModelProvider<span class="token punctuation">.</span>Factory<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>VM<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">ActivityViewModelLazy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> VM<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/**
 * An implementation of [Lazy] used by [ComponentActivity.viewModels] tied to the given [activity],
 * [viewModelClass], [factory]
 */</span>
<span class="token keyword">class</span> ActivityViewModelLazy<span class="token operator">&lt;</span>VM <span class="token operator">:</span> ViewModel<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> activity<span class="token operator">:</span> ComponentActivity<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> viewModelClass<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>VM<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> factory<span class="token operator">:</span> ViewModelProvider<span class="token punctuation">.</span>Factory<span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>VM<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> cached<span class="token operator">:</span> VM<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> value<span class="token operator">:</span> VM
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> viewModel <span class="token operator">=</span> cached
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> application <span class="token operator">=</span> activity<span class="token punctuation">.</span>application
                    <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"ViewModel can be accessed "</span> <span class="token operator">+</span>
                                <span class="token string">"only when Activity is attached"</span>
                    <span class="token punctuation">)</span>
                <span class="token keyword">val</span> resolvedFactory <span class="token operator">=</span> factory <span class="token operator">?:</span> AndroidViewModelFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
                viewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> resolvedFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewModelClass<span class="token punctuation">.</span>java<span class="token punctuation">)</span>
                cached <span class="token operator">=</span> viewModel
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> viewModel
        <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> cached <span class="token operator">!=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre>
<p><strong><a href="https://android.googlesource.com/platform/frameworks/support/+/0699f8f5b5aa7d79ba48d57a3710989ae2f50ee3/fragment/ktx/src/main/java/androidx/fragment/app/FragmentViewModelLazy.kt" target="_blank" rel="noopener">FragmentViewModelLazy</a></strong></p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@MainThread</span>
<span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span><span class="token keyword">reified</span> VM <span class="token operator">:</span> ViewModel<span class="token operator">></span> Fragment<span class="token punctuation">.</span><span class="token function">viewModels</span><span class="token punctuation">(</span>factory<span class="token operator">:</span> Factory<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>VM<span class="token operator">></span> <span class="token operator">=</span>
    <span class="token function">FragmentViewModelLazy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> VM<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">/**
 * An implementation of [Lazy] used by [Fragment.viewModels] tied to the given [fragment],
 * [viewModelClass], [factory]
 */</span>
<span class="token keyword">class</span> FragmentViewModelLazy<span class="token operator">&lt;</span>VM <span class="token operator">:</span> ViewModel<span class="token operator">></span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> fragment<span class="token operator">:</span> Fragment<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> viewModelClass<span class="token operator">:</span> KClass<span class="token operator">&lt;</span>VM<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> factory<span class="token operator">:</span> Factory<span class="token operator">?</span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Lazy<span class="token operator">&lt;</span>VM<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> cached<span class="token operator">:</span> VM<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">override</span> <span class="token keyword">val</span> value<span class="token operator">:</span> VM
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> viewModel <span class="token operator">=</span> cached
            <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModel <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> application <span class="token operator">=</span> fragment<span class="token punctuation">.</span>activity<span class="token operator">?</span><span class="token punctuation">.</span>application
                    <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">IllegalArgumentException</span><span class="token punctuation">(</span>
                        <span class="token string">"ViewModel can be accessed "</span> <span class="token operator">+</span>
                                <span class="token string">"only when Fragment is attached"</span>
                    <span class="token punctuation">)</span>
                <span class="token keyword">val</span> resolvedFactory <span class="token operator">=</span> factory <span class="token operator">?:</span> AndroidViewModelFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>application<span class="token punctuation">)</span>
                viewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span>fragment<span class="token punctuation">,</span> resolvedFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>viewModelClass<span class="token punctuation">.</span>java<span class="token punctuation">)</span>
                cached <span class="token operator">=</span> viewModel
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> viewModel
        <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">isInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> cached <span class="token operator">!=</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5-3-SP-delegates"><a href="#5-3-SP-delegates" class="headerlink" title="5.3 SP delegates"></a>5.3 SP delegates</h3><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> SharedPreferences<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span>def<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token function">delegate</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> key<span class="token punctuation">,</span> SharedPreferences<span class="token operator">::</span>getInt<span class="token punctuation">,</span> SharedPreferences<span class="token punctuation">.</span>Editor<span class="token operator">::</span>putInt<span class="token punctuation">)</span>

<span class="token keyword">fun</span> SharedPreferences<span class="token punctuation">.</span><span class="token function">long</span><span class="token punctuation">(</span>def<span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token function">delegate</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> key<span class="token punctuation">,</span> SharedPreferences<span class="token operator">::</span>getLong<span class="token punctuation">,</span> SharedPreferences<span class="token punctuation">.</span>Editor<span class="token operator">::</span>putLong<span class="token punctuation">)</span>

<span class="token keyword">fun</span> SharedPreferences<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span>def<span class="token operator">:</span> String <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> key<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=</span>
    <span class="token function">delegate</span><span class="token punctuation">(</span>def<span class="token punctuation">,</span> key<span class="token punctuation">,</span> SharedPreferences<span class="token operator">::</span>getString<span class="token punctuation">,</span> SharedPreferences<span class="token punctuation">.</span>Editor<span class="token operator">::</span>putString<span class="token punctuation">)</span>


<span class="token keyword">private</span> <span class="token keyword">inline</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> SharedPreferences<span class="token punctuation">.</span><span class="token function">delegate</span><span class="token punctuation">(</span>
    defaultValue<span class="token operator">:</span> T<span class="token punctuation">,</span>
    key<span class="token operator">:</span> String<span class="token operator">?</span><span class="token punctuation">,</span>
    <span class="token keyword">crossinline</span> getter<span class="token operator">:</span> SharedPreferences<span class="token punctuation">.</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">,</span>
    <span class="token keyword">crossinline</span> setter<span class="token operator">:</span> SharedPreferences<span class="token punctuation">.</span>Editor<span class="token punctuation">.</span><span class="token punctuation">(</span>String<span class="token punctuation">,</span> T<span class="token punctuation">)</span> <span class="token operator">-></span> SharedPreferences<span class="token punctuation">.</span>Editor
<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ReadWriteProperty<span class="token operator">&lt;</span>Any<span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">getter</span><span class="token punctuation">(</span>key <span class="token operator">?:</span> property<span class="token punctuation">.</span>name<span class="token punctuation">,</span> defaultValue<span class="token punctuation">)</span>

    <span class="token annotation builtin">@SuppressLint</span><span class="token punctuation">(</span><span class="token string">"CommitPrefEdits"</span><span class="token punctuation">)</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">setValue</span><span class="token punctuation">(</span>thisRef<span class="token operator">:</span> Any<span class="token punctuation">,</span> property<span class="token operator">:</span> KProperty<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">,</span> value<span class="token operator">:</span> T<span class="token punctuation">)</span> <span class="token operator">=</span>
        <span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>key <span class="token operator">?:</span> property<span class="token punctuation">.</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>测试代码</p>
<pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">TokenHolder</span><span class="token punctuation">(</span>prefs<span class="token operator">:</span> SharedPreferences<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> token<span class="token operator">:</span> String <span class="token keyword">by</span> prefs<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">var</span> count <span class="token keyword">by</span> prefs<span class="token punctuation">.</span><span class="token function">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">fun</span> <span class="token function">saveToken</span><span class="token punctuation">(</span>newToken<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        token <span class="token operator">=</span> newToken
        count<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"TokenHolder(token='<span class="token interpolation variable">$token</span>', count=<span class="token interpolation variable">$count</span>)"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token function">UserHolder</span><span class="token punctuation">(</span>prefs<span class="token operator">:</span> SharedPreferences<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name<span class="token operator">:</span> String <span class="token keyword">by</span> prefs<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">var</span> pwd<span class="token operator">:</span> String <span class="token keyword">by</span> prefs<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">private</span> <span class="token keyword">set</span>
    <span class="token keyword">fun</span> <span class="token function">saveUserAccount</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">,</span> pwd<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">this</span><span class="token punctuation">.</span>pwd <span class="token operator">=</span> pwd
    <span class="token punctuation">}</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"UserHolder(name='<span class="token interpolation variable">$name</span>', pwd='<span class="token interpolation variable">$pwd</span>')"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">val</span> prefs <span class="token operator">=</span> <span class="token function">getSharedPreferences</span><span class="token punctuation">(</span><span class="token string">"sp_app_jay"</span><span class="token punctuation">,</span> Context<span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//缓存Token的场景</span>
<span class="token keyword">val</span> tokenHolder <span class="token operator">=</span> <span class="token function">TokenHolder</span><span class="token punctuation">(</span>prefs<span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Jay"</span><span class="token punctuation">,</span> <span class="token string">"tokenHolder:<span class="token interpolation variable">$tokenHolder</span>"</span><span class="token punctuation">)</span>
tokenHolder<span class="token punctuation">.</span><span class="token function">saveToken</span><span class="token punctuation">(</span><span class="token string">"token_one"</span><span class="token punctuation">)</span>
tokenHolder<span class="token punctuation">.</span><span class="token function">saveToken</span><span class="token punctuation">(</span><span class="token string">"token_second"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//缓存登录信息的场景</span>
<span class="token keyword">val</span> userHolder <span class="token operator">=</span> <span class="token function">UserHolder</span><span class="token punctuation">(</span>prefs<span class="token punctuation">)</span>
Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Jay"</span><span class="token punctuation">,</span> <span class="token string">"userHolder:<span class="token interpolation variable">$userHolder</span>"</span><span class="token punctuation">)</span>
userHolder<span class="token punctuation">.</span><span class="token function">saveUserAccount</span><span class="token punctuation">(</span><span class="token string">"jay"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span></code></pre>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>本篇文章围绕 Kotlin 的内置委托(Delegation﻿) 特性并结合代码实践分别阐述了 Kotlin 委托的原理(包括属性委托和接口委托)，尤其是属性委托从属性到委托详细阐述了其实现原理，</p>
<p>然后是实践部分，首先是Kotlin 标准库中利用属性委托为我们封装了很多简洁的API，比如：map、lazy、notNull、Observable 等；然后是Kotlin 属性委托在 Android 上的一些实践，包括 VB、VM、SP 等利用属性委托基本上都能完成一行代码实现set/get。Kotlin 委托显然在消除样板代码方面能发挥出强大的作用。但是这每个属性的背后却对应这一个委托类，所以在大量使用时也需要兼顾性能。</p>
<h2 id="7-参考"><a href="#7-参考" class="headerlink" title="7. 参考"></a>7. 参考</h2><p><a href="https://www.kotlincn.net/docs/reference/delegation.html" target="_blank" rel="noopener">官方文档 | 委托</a></p>
<p><a href="https://www.kotlincn.net/docs/reference/delegated-properties.html" target="_blank" rel="noopener">官方文档 | 属性委托</a></p>
<p><a href="https://coding.imooc.com/class/398.html" target="_blank" rel="noopener">慕课网 | 新版 Kotlin 从入门到精通</a></p>
<p><a href="https://juejin.cn/post/6844904038589267982" target="_blank" rel="noopener">一文彻底搞懂Kotlin中的委托</a></p>
<p><a href="https://en.wikipedia.org/wiki/Delegation_pattern" target="_blank" rel="noopener">Wikipedia | Delegation pattern</a></p>
<p><a href="https://en.wikipedia.org/wiki/Proxy_pattern" target="_blank" rel="noopener">Wikipedia | Proxy pattern</a></p>
<p><a href="https://proandroiddev.com/kotlin-delegates-in-android-1ab0a715762d" target="_blank" rel="noopener">Medium | Kotlin Delegates in Android</a></p>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Jay</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://www.basedev.cn/2021/08/31/kotlin-delegate/">http://www.basedev.cn/2021/08/31/kotlin-delegate/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Jay</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/ViewBinding/">
                                    <span class="chip bg-color">ViewBinding</span>
                                </a>
                            
                                <a href="/tags/Kotlin-%E5%A7%94%E6%89%98/">
                                    <span class="chip bg-color">Kotlin 委托</span>
                                </a>
                            
                                <a href="/tags/%E5%B1%9E%E6%80%A7%E5%A7%94%E6%89%98/">
                                    <span class="chip bg-color">属性委托</span>
                                </a>
                            
                                <a href="/tags/ViewModel/">
                                    <span class="chip bg-color">ViewModel</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat,qq,qzone,weibo,twitter,facebook,google,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    
        <link rel="stylesheet" href="/libs/gitment/gitment-default.css">
<link rel="stylesheet" href="/css/gitment.css">

<div class="gitment-card card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitment-content" class="card-content"></div>
</div>

<script src="/libs/gitment/gitment.js"></script>
<script>
var gitment = new Gitment({
    id: 'Tue Aug 31 2021 14:16:55 GMT+0800',
    owner: 'jaydroid1024',
    repo: 'hexo_blog_repo',
    oauth: {
        client_id: '4c4d58f27f5177dff57c',
        client_secret: 'c9fce45c9250437cb34e3a7755c4135df47aa65b'
    }
});

gitment.render('gitment-content');
</script>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/10/31/code-all/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/19.jpg" class="responsive-img" alt="筑基系列-算法大全（更新中...）">
                        
                        <span class="card-title">筑基系列-算法大全（更新中...）</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            链表、排序、字符串、二叉树等等
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-10-31
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%AE%97%E6%B3%95/" class="post-category">
                                    算法
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%AE%97%E6%B3%95/">
                        <span class="chip bg-color">算法</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/07/31/jdispatcher/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="JDispatcher-Android组件生命周期分发框架">
                        
                        <span class="card-title">JDispatcher-Android组件生命周期分发框架</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Android 组件生命周期分发框架，适用于组件化，模块化，启动优化等场景
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-07-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%A1%86%E6%9E%B6/" class="post-category">
                                    框架
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E7%BB%84%E4%BB%B6%E5%8C%96/">
                        <span class="chip bg-color">组件化</span>
                    </a>
                    
                    <a href="/tags/%E6%B3%A8%E8%A7%A3/">
                        <span class="chip bg-color">注解</span>
                    </a>
                    
                    <a href="/tags/Gradle-Plugin/">
                        <span class="chip bg-color">Gradle Plugin</span>
                    </a>
                    
                    <a href="/tags/ASM/">
                        <span class="chip bg-color">ASM</span>
                    </a>
                    
                    <a href="/tags/APT/">
                        <span class="chip bg-color">APT</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 王学杰<br />'
            + '文章作者: Jay<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        font-size: 15px;
        color: #42b983;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.3'
                   list-folded='false'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2021</span>
            <a href="/about" target="_blank">Jay</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">110.8k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2021";
                    var startMonth = "1";
                    var startDate = "1";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
            <span id="icp"><img src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="https://beian.miit.gov.cn/" target="_blank">京ICP备2020043565号-1</a>
            </span>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/jaydroid1024" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:wangxuejie@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1018673209" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1018673209" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?88efcea1b43fcd428172af2f7305f80e";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
